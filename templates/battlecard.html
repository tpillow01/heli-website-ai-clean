{% set title = (model.model or model._display) %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ title }} – Battle Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=44) }}">
  <style>
    :root{ --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6; --ink:#5e4b3f; --muted:#8a796d; --brand:#cc0000; --ink-2:#3e3028; }
    body{margin:0;background:repeating-linear-gradient(0deg,#f3eadc 0 28px,#f1e6d6 28px 29px);color:var(--ink)}
    .top{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.6);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .brand{display:flex;justify-content:space-between;align-items:center}
    .brand .left{font-weight:900;color:#7e5140}
    .brand .right{font-weight:900;color:#a9342a;letter-spacing:.08em}
    .tabs{display:flex;gap:16px;align-items:center;margin:10px 0 8px}
    .nav-link{background:transparent;border:none;padding:8px 0;color:var(--ink);font-weight:800;text-decoration:none;border-radius:6px;position:relative}
    .nav-link.active{color:#1f1713}
    .nav-link.active::after{content:"";position:absolute;left:0;bottom:-6px;width:24px;height:3px;border-radius:2px;background:var(--brand)}

    /* hero */
    .crumbs{margin:8px 0 6px}
    .crumbs a{color:#7b6559;text-decoration:none}
    .crumbs a:hover{text-decoration:underline}
    .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:center;margin:6px 0 12px}
    .title{margin:0;color:#2f231e;font-weight:900;letter-spacing:.01em}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:800;color:#6a5146}
    .badge{background:#f1dfcf;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-weight:800;color:#8f4f3b}
    .sil{height:200px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#f8f2e9,#f4eadf);box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0}

    /* two-column content */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--cream);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0}
    .panel h2{margin:0 0 10px 0;color:#6b4c3e}
    .bullets{margin:0;padding-left:18px}

    /* specs */
    .specs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .spec{display:flex;justify-content:space-between;gap:10px;background:var(--cream-2);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .spec span{color:#8a796d}
    .spec b{color:#2f231e}

    /* AI CTA row */
    .cta{display:flex;gap:10px;justify-content:flex-end;margin:18px 0}
    .btn-ask{background:linear-gradient(#d8493f,#c61c10);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:900;letter-spacing:.03em;box-shadow:0 6px 18px rgba(204,0,0,.25);cursor:pointer}
    .btn-outline{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-weight:800;color:#63463a;cursor:pointer}

    /* modal */
    dialog.ai{border:none;border-radius:18px;padding:0;background:transparent}
    dialog.ai::backdrop{background:rgba(0,0,0,.35)}
    .modal{background:var(--cream);border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:0 8px 26px rgba(93,69,49,.12), inset 0 1px 0 #fff8f0;width:min(820px,92vw)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .tabs2{display:flex;gap:8px}
    .tab{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:800;color:#5b463b;cursor:pointer}
    .tab.active{background:#f1dfcf}
    .modal-body{padding:16px 16px 18px 16px;min-height:180px;color:#493a31}
    .btn-close{background:#fff;border:1px solid var(--line);border-radius:10px;padding:7px 10px;font-weight:700;color:#63463a}
    .spinner{width:34px;height:34px;border-radius:50%;border:4px solid #e0d4c4;border-top-color:#cc0000;margin:24px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:900px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .cta{justify-content:center}
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="brand">
        <div class="left">Tynan Equipment AI</div>
        <div class="right">HELI</div>
      </div>
      <nav class="tabs">
        <a href="/"            class="nav-link {{ 'active' if request.path == '/' else '' }}">Chat</a>
        <a href="/map"         class="nav-link {{ 'active' if request.path.startswith('/map') else '' }}">Map</a>
        <a href="/battlecards" class="nav-link {{ 'active' if request.path.startswith('/battlecards') else '' }}">Battle Cards</a>
      </nav>
    </div>
  </div>

  <main class="wrap">
    <div class="crumbs"><a href="/battlecards">← Back to Battle Cards</a></div>

    <section class="hero">
      <div>
        <h1 class="title">{{ (model.series or "Series") | upper }} – {{ title }}</h1>
        <div class="meta">
          {% if model.power and model.power != '—' %}<div class="chip">{{ model.power }}</div>{% endif %}
          {% if model.capacity and "Not specified" not in model.capacity %}<div class="chip">Capacity: {{ model.capacity }}</div>{% endif %}
          {% if model.drive_type and model.drive_type != '—' %}<div class="chip">{{ model.drive_type }}</div>{% endif %}
          {% if model.overall_width and "Not specified" not in model.overall_width %}<div class="badge">Width {{ model.overall_width }}</div>{% endif %}
          {% if model.turning_radius and "Not specified" not in model.turning_radius %}<div class="badge">Turning {{ model.turning_radius }}</div>{% endif %}
        </div>
      </div>
      <div class="sil" aria-hidden="true"></div>
    </section>

    <section class="grid">
      <article class="panel">
        <h2>Best Environments</h2>
        <ul class="bullets">
          <li>Indoors: {{ model.indoors }}</li>
          <li>Outdoors: {{ model.outdoors }}</li>
          <li>Special: {{ model.special_env }}</li>
        </ul>
      </article>

      <article class="panel">
        <h2>Key Specs</h2>
        <div class="specs">
          <div class="spec"><span>Power</span><b>{{ model.power }}</b></div>
          <div class="spec"><span>Drive Type</span><b>{{ model.drive_type }}</b></div>
          <div class="spec"><span>Controller</span><b>{{ model.controller }}</b></div>
          <div class="spec"><span>Capacity</span><b>{{ model.capacity }}</b></div>
          <div class="spec"><span>Load Center</span><b>{{ model.load_center }}</b></div>
          <div class="spec"><span>Turning Radius</span><b>{{ model.turning_radius }}</b></div>
          <div class="spec"><span>Overall Width</span><b>{{ model.overall_width }}</b></div>
          <div class="spec"><span>Overall Length</span><b>{{ model.overall_length }}</b></div>
          <div class="spec"><span>Overall Height</span><b>{{ model.overall_height }}</b></div>
          <div class="spec"><span>Wheel Base</span><b>{{ model.wheel_base }}</b></div>
          <div class="spec"><span>Max Lift Height</span><b>{{ model.max_lift_height }}</b></div>
          <div class="spec"><span>Battery Voltage</span><b>{{ model.battery_voltage }}</b></div>
        </div>
      </article>

      <article class="panel" style="grid-column:1/-1">
        <h2>Why It Wins</h2>
        <ul class="bullets">
          {% for p in model.why_wins %}<li>{{ p }}</li>{% endfor %}
        </ul>
      </article>
    </section>

    <div class="cta">
      <button id="openBrief" class="btn-outline">Open Briefing</button>
      <button id="askAiBtn" class="btn-ask">ASK AI FOR FIT</button>
    </div>

    <dialog id="aiFitDialog" class="ai">
      <div class="modal">
        <div class="modal-head">
          <div class="tabs2">
            <button class="tab active" data-tab="fit">Fit Briefing</button>
            <button class="tab" data-tab="edge">Competitive Edge</button>
          </div>
          <button id="closeAi" class="btn-close">Close</button>
        </div>
        <div id="aiOutput" class="modal-body"><div class="spinner"></div></div>
      </div>
    </dialog>
  </main>

  <script>
    const slug = "{{ model._slug }}";
    const dlg = document.getElementById('aiFitDialog');
    const out = document.getElementById('aiOutput');
    const btnAsk = document.getElementById('askAiBtn');
    const btnOpen = document.getElementById('openBrief');
    const closeBtn = document.getElementById('closeAi');
    const tabBtns = Array.from(document.querySelectorAll('.tab'));
    let cacheHTML = null;

    function setTab(name){
      tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      const blocks = out.querySelectorAll('[data-block]');
      blocks.forEach(el => el.style.display = (el.dataset.block === name ? '' : 'none'));
    }

    async function ensureContent(){
      if (cacheHTML) return;
      out.innerHTML = '<div class="spinner"></div>';
      const r = await fetch(`/api/ai_fit?model=${encodeURIComponent(slug)}`);
      const j = await r.json();
      out.innerHTML = j.html ? j.html : `<pre>${(j.error||'Unknown error')}</pre>`;
      cacheHTML = out.innerHTML;
    }

    btnAsk.addEventListener('click', async () => {
      if (typeof dlg.showModal === 'function') dlg.showModal();
      await ensureContent();
      setTab('edge'); // jump straight to Competitive Edge for sales reps
    });

    btnOpen.addEventListener('click', async () => {
      if (typeof dlg.showModal === 'function') dlg.showModal();
      await ensureContent();
      setTab('fit');
    });

    closeBtn.addEventListener('click', () => dlg.close());

    tabBtns.forEach(b => b.addEventListener('click', () => setTab(b.dataset.tab)));
  </script>
</body>
</html>
