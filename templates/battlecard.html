<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Battle Card – {{ model.model }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=47) }}">

  <style>
    :root{
      /* spacing scale */
      --s-8: 8px; --s-10: 10px; --s-12: 12px; --s-14: 14px; --s-16: 16px;
      --s-18: 18px; --s-20: 20px; --s-22: 22px; --s-24: 24px; --s-28: 28px;

      /* palette (matches your site) */
      --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6;
      --ink:#3b2a23; --muted:#746055; --brand:#a9342a; --brand-2:#c64a3f;
    }

    /* ===== Header (site) ===== */
    .bc-top{
      position:sticky; top:0; z-index:50;
      background:rgba(246,239,227,.92);
      backdrop-filter:saturate(1.05) blur(6px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1180px;margin:0 auto;padding: var(--s-14) var(--s-18);}
    .brand-line{display:flex;align-items:center;justify-content:space-between;gap:var(--s-16)}
    .brand-left{font-weight:900;letter-spacing:.02em;color:#6e4d3e}
    .brand-right{font-weight:900;color:#a9342a;letter-spacing:.08em}
    .tabs{display:flex;gap:var(--s-18);align-items:center;margin-top:var(--s-8)}
    .nav-link{
      text-decoration:none;color:var(--ink);font-weight:800;position:relative;padding: var(--s-8) 0;
    }
    .nav-link.active{color:#1f1713}
    .nav-link.active::after{
      content:""; position:absolute; left:0; bottom:-6px; width:30px; height:3px; border-radius:2px; background:var(--brand);
    }

    /* ===== Page wrap ===== */
    body{color:var(--ink)}
    .page{max-width:1180px;margin:0 auto;padding: var(--s-18);}
    .grid{display:grid;grid-template-columns:3fr 1.35fr;gap: var(--s-22); align-items:start;}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* ===== Cards ===== */
    .card{
      background:var(--cream);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0;
      padding: var(--s-22) var(--s-24);
    }
    /* make sure content never touches edges */
    .card > * + *{margin-top: var(--s-18)}

    /* ===== Hero ===== */
    .hero-bar{display:flex;align-items:center;justify-content:space-between;gap:var(--s-16)}
    .title{margin:0; font-weight:900; line-height:1.15; color:var(--ink); font-size: clamp(22px,2.2vw,32px); padding-bottom:6px; position:relative}
    .title::after{content:""; position:absolute; left:0; bottom:-2px; height:4px; width:64px; border-radius:3px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2))}
    .btn{
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800; color:#5e4b3f;
      border:2px solid transparent;
      background:linear-gradient(#fff,#fff) padding-box, linear-gradient(135deg,var(--brand),var(--brand-2)) border-box;
      box-shadow:0 6px 16px rgba(50,40,30,.10);
    }
    .btn:hover{box-shadow:0 10px 26px rgba(50,40,30,.16), 0 0 0 4px rgba(201,68,58,.08)}
    .pills{display:flex; flex-wrap:wrap; gap: var(--s-10)}
    .pill{
      background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; font-weight:800; color:#63463a;
      box-shadow: inset 0 1px 0 #fff, 0 6px 12px rgba(50,40,30,.05);
    }
    .metrics{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap: var(--s-12)}
    @media (max-width:560px){.metrics{grid-template-columns:1fr}}
    .metric{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding: var(--s-14) var(--s-16);
    }
    .metric .k{font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:#866f62; font-weight:900; margin-bottom:4px}
    .metric .v{font-weight:900; color:var(--ink); font-size:18px}

    /* ===== Blocks ===== */
    .block h2{margin:0; font-size:20px; font-weight:900}
    .kv{display:flex; gap: var(--s-8)}
    .kv .k{font-weight:900}
    .kv .v{color:var(--muted)}
    .why ul{margin:0; padding-left:1.1em}
    .why li{margin: 8px 0; line-height:1.5}

    /* ===== Specs ===== */
    .specs{padding: var(--s-18) var(--s-18)}
    .specs h3{margin:0 0 var(--s-12) 2px; font-size:18px; font-weight:900}
    .spec{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:1px solid var(--line); border-radius:12px; padding: var(--s-12) var(--s-14); margin: var(--s-10) 0;
    }
    .spec .k{color:#7a5f53; font-weight:900}
    .spec .v{color:#2f241f; font-weight:900}

    /* ===== Modal ===== */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:60; padding: var(--s-24)}
    .modal.show{display:grid}
    .modal-card{
      width:min(920px,96vw); max-height:85vh; overflow:auto;
      background:var(--cream); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25)
    }
    .modal-head{
      position:sticky; top:0; z-index:1; display:flex; align-items:center; justify-content:space-between; gap:var(--s-12);
      padding: var(--s-10) var(--s-12); border-bottom:1px solid var(--line); background:#fff
    }
    .segmented{display:inline-flex; gap:4px; background:#f7efe2; border:1px solid var(--line); border-radius:12px; padding:4px}
    .tab{appearance:none; border:0; background:transparent; color:#604c41; font-weight:900; padding:8px 12px; border-radius:10px; cursor:pointer; min-width:140px}
    .tab.active{background:#fff; border:1px solid var(--line); box-shadow:0 4px 12px rgba(50,40,30,.10)}
    .close-x{border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900}
    .modal-body{padding: var(--s-18) var(--s-20)}
    .modal-body .briefing-content h2{margin: 8px 0 6px; font-size:22px; font-weight:900; border-bottom:2px solid #ead9c6; padding-bottom:6px}
    .modal-body .briefing-content ul{margin:8px 0 12px; padding-left:1.15em}
    .modal-body .briefing-content li{margin: 6px 0; line-height:1.55}
  </style>
</head>
<body>

  <!-- ===== Header restored ===== -->
  <header class="bc-top">
    <div class="container">
      <div class="brand-line">
        <div class="brand-left">Tynan Equipment AI</div>
        <div class="brand-right">HELI</div>
      </div>
      <nav class="tabs">
        <a href="{{ url_for('home') if 'home' in globals() else '/' }}" class="nav-link">Chat</a>
        <a href="{{ url_for('map_page') if 'map_page' in globals() else '/map' }}" class="nav-link">Map</a>
        <a href="{{ url_for('battlecards_index') }}" class="nav-link active">Battle Cards</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hero-bar">
          <h1 class="title">{{ model.series }} – {{ model.model }}</h1>
          <button id="open-briefing-trigger" class="btn" type="button" data-slug="{{ model._slug }}">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Open Briefing
          </button>
        </div>

        <div class="pills">
          {% if model.power %}<span class="pill">{{ model.power }}</span>{% endif %}
          {% if model.capacity %}<span class="pill">Capacity: {{ model.capacity }}</span>{% endif %}
          {% if model.drive_type and model.drive_type != '—' %}<span class="pill">{{ model.drive_type }}</span>{% endif %}
        </div>

        <div class="metrics">
          <div class="metric"><div class="k">Width</div><div class="v">{{ model.overall_width }}</div></div>
          <div class="metric"><div class="k">Turning</div><div class="v">{{ model.turning_radius }}</div></div>
          <div class="metric"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        </div>
      </section>

      <!-- RIGHT: Specs -->
      <aside class="card specs">
        <h3>Key Specs</h3>
        <div class="spec"><div class="k">Power</div><div class="v">{{ model.power }}</div></div>
        <div class="spec"><div class="k">Drive Type</div><div class="v">{{ model.drive_type }}</div></div>
        <div class="spec"><div class="k">Controller</div><div class="v">{{ model.controller }}</div></div>
        <div class="spec"><div class="k">Capacity</div><div class="v">{{ model.capacity }}</div></div>
        <div class="spec"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        <div class="spec"><div class="k">Turning Radius</div><div class="v">{{ model.turning_radius }}</div></div>
        <div class="spec"><div class="k">Overall Width</div><div class="v">{{ model.overall_width }}</div></div>
        <div class="spec"><div class="k">Overall Length</div><div class="v">{{ model.overall_length }}</div></div>
        <div class="spec"><div class="k">Overall Height</div><div class="v">{{ model.overall_height }}</div></div>
        <div class="spec"><div class="k">Wheel Base</div><div class="v">{{ model.wheel_base }}</div></div>
        <div class="spec"><div class="k">Max Lift Height</div><div class="v">{{ model.max_lift_height }}</div></div>
        <div class="spec"><div class="k">Battery Voltage</div><div class="v">{{ model.battery_voltage }}</div></div>
      </aside>

      <!-- Environments -->
      <section class="card block">
        <h2>Best Environments</h2>
        <p class="kv"><span class="k">Indoors:</span><span class="v">{{ model.indoors }}</span></p>
        <p class="kv"><span class="k">Outdoors:</span><span class="v">{{ model.outdoors }}</span></p>
        <p class="kv"><span class="k">Special:</span><span class="v">{{ model.special_env }}</span></p>
      </section>

      <!-- Why it wins -->
      <section class="card block why" style="grid-column:1 / -1">
        <h2>Why It Wins</h2>
        <ul>
          {% for w in model.why_wins %}<li>{{ w }}</li>{% endfor %}
        </ul>
      </section>
    </div>
  </main>

  <!-- Briefing Modal (unchanged structure; spacing improved) -->
  <div id="briefing-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="modal-card">
      <div class="modal-head">
        <div class="segmented" role="tablist" aria-label="Briefing tabs">
          <button class="tab active" role="tab" aria-selected="true"  aria-controls="tab-fit"  id="tabbtn-fit"  data-tab="fit">Fit Briefing</button>
          <button class="tab"        role="tab" aria-selected="false" aria-controls="tab-edge" id="tabbtn-edge" data-tab="edge">Competitive Edge</button>
        </div>
        <button class="close-x" aria-label="Close briefing">Close</button>
      </div>
      <div class="modal-body" id="tab-panel">
        <p class="loading">Loading briefing…</p>
      </div>
    </div>
  </div>

  <!-- ES5 JS (briefing) -->
  <script>
  (function () {
    var openBtn = document.getElementById('open-briefing-trigger');
    var modal   = document.getElementById('briefing-modal');
    var body    = modal.querySelector('.modal-body');
    var tabs    = modal.querySelectorAll('.tab');
    var closeX  = modal.querySelector('.close-x');
    var slug    = openBtn.getAttribute('data-slug');

    var fitHTML  = '';
    var edgeHTML = '';

    function openModal() {
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    function setActiveTab(name) {
      for (var i=0;i<tabs.length;i++){
        var t = tabs[i];
        var on = (t.getAttribute('data-tab') === name);
        t.classList.toggle('active', on);
        t.setAttribute('aria-selected', on ? 'true' : 'false');
      }
      var html = (name === 'fit') ? (fitHTML || '<p>Unavailable.</p>')
                                  : (edgeHTML || '<p>Unavailable.</p>');
      body.innerHTML = '<div class="briefing-content">'+ html +'</div>';
    }
    function fetchBriefing() {
      body.innerHTML = '<p class="loading">Loading briefing…</p>';
      fetch('/api/ai_fit?model=' + encodeURIComponent(slug))
        .then(function(r){ return r.json(); })
        .then(function(j){
          if (j && j.html) {
            var wrap = document.createElement('div');
            wrap.innerHTML = j.html;
            var fit  = wrap.querySelector('[data-block="fit"]');
            var edge = wrap.querySelector('[data-block="edge"]');
            fitHTML  = fit  ? fit.outerHTML  : j.html;
            edgeHTML = edge ? edge.outerHTML : '';
            setActiveTab('fit');
          } else {
            body.innerHTML = '<p>Error: ' + (j && j.error ? j.error : 'No content returned') + '</p>';
          }
        })
        .catch(function(err){
          body.innerHTML = '<p>Error loading briefing: ' + String(err) + '</p>';
        });
    }

    openBtn.addEventListener('click', function(){ openModal(); fetchBriefing(); });
    closeX.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });

    for (var i=0;i<tabs.length;i++){
      tabs[i].addEventListener('click', function(){ setActiveTab(this.getAttribute('data-tab')); });
    }
    modal.addEventListener('keydown', function(e){
      var activeIdx = -1;
      for (var i=0;i<tabs.length;i++){ if(tabs[i].classList.contains('active')) { activeIdx=i; break; } }
      if (e.key === 'ArrowRight') { e.preventDefault(); var idx = Math.min(activeIdx+1, tabs.length-1); tabs[idx].click(); tabs[idx].focus(); }
      if (e.key === 'ArrowLeft')  { e.preventDefault(); var idl = Math.max(activeIdx-1, 0); tabs[idl].click(); tabs[idl].focus(); }
      if (e.key === 'Enter' || e.key === ' ') {
        var el = document.activeElement; if (el && el.classList.contains('tab')) { e.preventDefault(); el.click(); }
      }
    });
  })();
  </script>
</body>
</html>
