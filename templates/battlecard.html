<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Battle Card – {{ model.model }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=43) }}">

  <style>
    :root{
      --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6;
      --ink:#3b2a23; --sub:#866f62; --muted:#7b6559; --brand:#a9342a;
    }
    body{color:var(--ink);}
    .bc-page{max-width:1180px;margin:0 auto;padding:18px;}
    .back-link{display:inline-block;margin:6px 0 14px 2px;color:#7a4d3a;font-weight:700;text-decoration:none}
    .back-link:hover{text-decoration:underline}

    /* layout */
    .bc-grid{display:grid; grid-template-columns: 3fr 1.4fr; gap:18px; align-items:start;}
    @media (max-width: 980px){ .bc-grid{ grid-template-columns: 1fr; } }

    /* shared card look */
    .card{
      background:var(--cream);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0;
    }

    /* HERO */
    .bc-hero{ padding:20px; }
    .bc-hero-bar{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .bc-title{ margin:0; font-weight:900; color:var(--ink); line-height:1.15; font-size:clamp(22px,2.2vw,32px); }
    .btn-briefing{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--line);
      background:#fff; color:#5e4b3f; font-weight:800; cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.06); transition:transform .06s ease, box-shadow .06s ease;
      white-space:nowrap;
    }
    .btn-briefing:hover{ box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .btn-briefing:active{ transform:translateY(1px); }
    .btn-briefing svg{ display:block }

    .bc-hero-pills{ display:flex; flex-wrap:wrap; gap:10px; margin:12px 0; }
    .pill{ background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; font-weight:800; color:#63463a; white-space:nowrap; }

    .bc-hero-metrics{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width: 540px){ .bc-hero-metrics{ grid-template-columns: 1fr; } }
    .metric{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px 14px; }
    .metric .k{ font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--sub); margin-bottom:4px; font-weight:800; }
    .metric .v{ font-size:18px; color:var(--ink); font-weight:900; }

    /* content blocks */
    .block{ padding:18px 20px; }
    .block h2{ margin:0 0 10px 0; font-size:20px; font-weight:900; }
    .kv{ display:flex; gap:8px; }
    .kv .k{ color:var(--ink); font-weight:800; }
    .kv .v{ color:var(--muted); }

    /* specs panel */
    .specs{ padding:14px; }
    .specs h3{ margin:6px 10px 10px 10px; font-weight:900; font-size:18px; }
    .spec-row{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:1px solid var(--line); border-radius:10px;
      padding:10px 12px; margin:8px 0;
    }
    .spec-row .k{ color:#7a5f53; font-weight:900; }
    .spec-row .v{ color:#2f241f; font-weight:900; }

    /* modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:60; padding:24px; }
    .modal.show{ display:grid; }
    .modal-card{
      width:min(900px, 96vw); max-height:85vh; overflow:auto;
      background:var(--cream); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25);
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:12px 14px; border-bottom:1px solid var(--line); background:#fff;
      position:sticky; top:0;
    }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:800; cursor:pointer; }
    .tab.active{ background:#f6efe3; }
    .close-x{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900; }

    /* Improved briefing spacing/typography */
    .modal-body{ padding:28px 30px; }
    .briefing-wrap{ max-width:820px; margin:0 auto; padding:2px 4px; }
    .briefing-wrap h1, .briefing-wrap h2, .briefing-wrap h3{ margin:0 0 10px; line-height:1.25; }
    .briefing-wrap h2{ font-size:22px; border-bottom:2px solid #ead9c6; padding-bottom:6px; }
    .briefing-wrap p{ margin:10px 0; }
    .briefing-wrap ul{ padding-left:1.2em; margin:8px 0 12px; }
    .briefing-wrap li{ margin:6px 0; line-height:1.55; }
    .loading{ font-style:italic; color:#6b5a50; }

    @media (max-width:680px){
      .bc-hero-bar{ flex-direction:column; align-items:flex-start; gap:10px; }
      .btn-briefing{ width:100%; justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="bc-page">
    <a class="back-link" href="{{ url_for('battlecards_index') }}">← Back to Battle Cards</a>

    <div class="bc-grid">
      <!-- LEFT COLUMN -->
      <div class="left-col">
        <!-- HERO -->
        <section class="card bc-hero">
          <div class="bc-hero-bar">
            <h1 class="bc-title">{{ model.series }} – {{ model.model }}</h1>
            <button id="open-briefing-trigger" class="btn-briefing" type="button" aria-haspopup="dialog">
              <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              Open Briefing
            </button>
          </div>

          <div class="bc-hero-pills">
            {% if model.power %}<span class="pill">{{ model.power }}</span>{% endif %}
            {% if model.capacity %}<span class="pill">Capacity: {{ model.capacity }}</span>{% endif %}
            {% if model.drive_type and model.drive_type != '—' %}<span class="pill">{{ model.drive_type }}</span>{% endif %}
          </div>

          <div class="bc-hero-metrics">
            <div class="metric"><div class="k">Width</div><div class="v">{{ model.overall_width }}</div></div>
            <div class="metric"><div class="k">Turning</div><div class="v">{{ model.turning_radius }}</div></div>
            <div class="metric"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
          </div>
        </section>

        <!-- Best Environments -->
        <section class="card block">
          <h2>Best Environments</h2>
          <p class="kv"><span class="k">Indoors:</span><span class="v">{{ model.indoors }}</span></p>
          <p class="kv"><span class="k">Outdoors:</span><span class="v">{{ model.outdoors }}</span></p>
          <p class="kv"><span class="k">Special:</span><span class="v">{{ model.special_env }}</span></p>
        </section>

        <!-- Why it wins -->
        <section class="card block">
          <h2>Why It Wins</h2>
          <ul>
            {% for w in model.why_wins %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </section>
      </div>

      <!-- RIGHT COLUMN: Key Specs -->
      <aside class="card specs">
        <h3>Key Specs</h3>

        <div class="spec-row"><div class="k">Power</div><div class="v">{{ model.power }}</div></div>
        <div class="spec-row"><div class="k">Drive Type</div><div class="v">{{ model.drive_type }}</div></div>
        <div class="spec-row"><div class="k">Controller</div><div class="v">{{ model.controller }}</div></div>

        <div class="spec-row"><div class="k">Capacity</div><div class="v">{{ model.capacity }}</div></div>
        <div class="spec-row"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        <div class="spec-row"><div class="k">Turning Radius</div><div class="v">{{ model.turning_radius }}</div></div>

        <div class="spec-row"><div class="k">Overall Width</div><div class="v">{{ model.overall_width }}</div></div>
        <div class="spec-row"><div class="k">Overall Length</div><div class="v">{{ model.overall_length }}</div></div>
        <div class="spec-row"><div class="k">Overall Height</div><div class="v">{{ model.overall_height }}</div></div>

        <div class="spec-row"><div class="k">Wheel Base</div><div class="v">{{ model.wheel_base }}</div></div>
        <div class="spec-row"><div class="k">Max Lift Height</div><div class="v">{{ model.max_lift_height }}</div></div>
        <div class="spec-row"><div class="k">Battery Voltage</div><div class="v">{{ model.battery_voltage }}</div></div>
      </aside>
    </div>
  </div>

  <!-- Pass data to JS safely (no Jinja inside <script>) -->
  <script id="page-data" type="application/json">
    {{ {"slug": model._slug}|tojson }}
  </script>

  <!-- Briefing Modal -->
  <div id="briefing-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="modal-card">
      <div class="modal-head">
        <div class="tabs">
          <button class="tab active" data-tab="fit">Fit Briefing</button>
          <button class="tab" data-tab="edge">Competitive Edge</button>
        </div>
        <button class="close-x" aria-label="Close briefing">Close</button>
      </div>
      <div class="modal-body">
        <p class="loading">Loading briefing…</p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var openBtn = document.getElementById('open-briefing-trigger');
      var modal   = document.getElementById('briefing-modal');
      var body    = modal.querySelector('.modal-body');
      var tabs    = modal.querySelectorAll('.tab');
      var closeX  = modal.querySelector('.close-x');

      var fitHTML = '';
      var edgeHTML = '';

      function openModal(){
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      function closeModal(){
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }
      function renderWithWrap(html){
        return '<div class="briefing-wrap">' + html + '</div>';
      }
      function setActiveTab(name){
        for (var i=0;i<tabs.length;i++){
          tabs[i].classList.toggle('active', tabs[i].getAttribute('data-tab') === name);
        }
        if(name === 'fit'){
          body.innerHTML = renderWithWrap(fitHTML || '<p>Unavailable.</p>');
        } else {
          body.innerHTML = renderWithWrap(edgeHTML || '<p>Unavailable.</p>');
        }
      }

      function getSlug(){
        try{
          var el = document.getElementById('page-data');
          var data = JSON.parse(el.textContent || '{}');
          return data.slug || '';
        }catch(e){
          return '';
        }
      }

      async function fetchBriefing(){
        body.innerHTML = '<p class="loading">Loading briefing…</p>';
        try{
          var slug = getSlug();
          var r = await fetch('/api/ai_fit?model=' + encodeURIComponent(slug));
          var j = await r.json();
          if(j && j.html){
            // Parse HTML safely and pick out blocks
            var wrapper = document.createElement('div');
            wrapper.innerHTML = j.html;
            var fit  = wrapper.querySelector('[data-block="fit"]');
            var edge = wrapper.querySelector('[data-block="edge"]');
            fitHTML  = fit  ? fit.outerHTML  : '<p>Unavailable.</p>';
            edgeHTML = edge ? edge.outerHTML : '<p>Unavailable.</p>';
            setActiveTab('fit');
          }else{
            body.innerHTML = renderWithWrap('<p>Error: ' + (j && j.error ? j.error : 'No content returned') + '</p>');
          }
        }catch(err){
          body.innerHTML = renderWithWrap('<p>Error loading briefing: ' + String(err) + '</p>');
        }
      }

      if (openBtn){
        openBtn.addEventListener('click', function(){ openModal(); fetchBriefing(); });
      }
      closeX.addEventListener('click', closeModal);
      modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
      for (var i=0;i<tabs.length;i++){
        tabs[i].addEventListener('click', function(){ setActiveTab(this.getAttribute('data-tab')); });
      }
    })();
  </script>
</body>
</html>
