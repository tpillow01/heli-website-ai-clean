<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Map (Segment / Territory / Geo Filters)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --brand: #cc0000;
      --ink: #1f1f1f;
      --bg: #f7f7f8;
      --card: #ffffff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--ink); }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--card); border-bottom: 1px solid #e6e6e8;
      gap: 10px; flex-wrap: wrap;
    }
    .title { font-weight: 600; }
    .controls {
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .controls label { font-size: 13px; color:#333; display:flex; gap:6px; align-items:center; }
    .controls select, .controls input[type="text"] {
      padding: 6px 10px; border-radius: 8px; border:1px solid #d0d0d5; background:#fff; font-size:14px;
    }
    .controls a {
      padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; text-decoration:none; color:var(--ink);
    }
    .controls a:hover { border-color: var(--brand); color: var(--brand); }
    #map { height: calc(100vh - 60px); width: 100vw; }
    .legend {
      background: white; padding: 8px 10px; border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2); font: 12px/1.1 system-ui, sans-serif;
      max-height: 30vh; overflow: auto;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .swatch { width:14px; height:14px; border-radius:50%; border:1px solid #0002; }

    /* ✅ AI Sidebar Popup */
    .ai-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 320px;
      max-height: 80vh;
      background: #fff;
      border: 2px solid #cc0000;
      border-radius: 8px;
      box-shadow: 0 0 10px #0003;
      z-index: 9999;
      padding: 16px;
      overflow-y: auto;
    }
    .ai-popup .ai-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .ai-popup button {
      background: #cc0000;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .ai-popup pre {
      white-space: pre-wrap;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Customer Map</div>
    <div class="controls">
      <label>Territory <select id="repFilter"><option value="__ALL__">All</option></select></label>
      <label>Segment
        <select id="segFilter">
          <option value="__ALL__">All</option>
          <option value="A">A only</option>
          <option value="B">B only</option>
          <option value="C">C only</option>
          <option value="D">D only</option>
        </select>
      </label>
      <label>State <select id="stateFilter"><option value="__ALL__">All</option></select></label>
      <label>County <select id="countyFilter" disabled><option value="__ALL__">All</option></select></label>
      <label>ZIP <input id="zipFilter" type="text" placeholder="Exact ZIP" size="8" /></label>
      <label><input type="checkbox" id="heatToggle"> Heatmap Mode</label>
      <a href="{{ url_for('home') }}">← Back to Chat</a>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map', { scrollWheelZoom: true }).setView([39.8, -98.6], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#393b79','#637939','#8c6d31','#843c39','#7b4173','#3182bd','#e6550d','#31a354','#756bb1','#969696'];
    const repIndex = new Map();
    const colorForRep = (rep) => {
      if (!repIndex.has(rep)) repIndex.set(rep, repIndex.size % palette.length);
      return palette[repIndex.get(rep)];
    };

    let allPoints = [];
    let layerGroup = L.featureGroup().addTo(map);
    let legendControl, heatLayer = null;

    const repFilter    = document.getElementById('repFilter');
    const segFilter    = document.getElementById('segFilter');
    const stateFilter  = document.getElementById('stateFilter');
    const countyFilter = document.getElementById('countyFilter');
    const zipFilter    = document.getElementById('zipFilter');
    const heatToggle   = document.getElementById('heatToggle');

    function markerStyle(rep) {
      const base = colorForRep(rep || 'Unassigned');
      return { radius: 7, weight: 1, color: '#333', fillColor: base, fillOpacity: 0.9 };
    }

    function withinRepFilter(pt) {
      const want = repFilter.value;
      return want === '__ALL__' || (pt.sales_rep || 'Unassigned') === want;
    }

    function withinSegFilter(pt) {
      const want = segFilter.value;
      if (want === '__ALL__') return true;
      const segLetter = (pt.segment && /^[ABCD]/.test(pt.segment)) ? pt.segment[0] : (pt.size_letter || 'C');
      return segLetter === want;
    }

    function withinStateCountyZip(pt) {
      const st = stateFilter.value;
      if (st !== '__ALL__' && (pt.state || '') !== st) return false;
      const cy = countyFilter.value;
      if (!countyFilter.disabled && cy !== '__ALL__' && (pt.county || '') !== cy) return false;
      const z = zipFilter.value.trim();
      if (z && (pt.zip || '') !== z) return false;
      return true;
    }

    function render() {
      layerGroup.clearLayers();
      if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
      }

      const toShow = allPoints.filter(p =>
        withinRepFilter(p) && withinSegFilter(p) && withinStateCountyZip(p)
      );

      if (heatToggle.checked) {
        const heatPoints = toShow.filter(p => p.lat && p.lon && p.total_r12 > 0).map(p => [p.lat, p.lon, p.total_r12 || 0]);
        heatLayer = L.heatLayer(heatPoints, { radius: 25 }).addTo(map);
      } else {
        const group = L.featureGroup();
        toShow.forEach(p => {
          const style = markerStyle(p.sales_rep);
          const marker = L.circleMarker([p.lat, p.lon], style);
          addAIButtonToPopup(marker, p.label);
          marker.addTo(group);
        });
        group.addTo(layerGroup);
        if (toShow.length) map.fitBounds(group.getBounds().pad(0.2));
        updateLegend();
      }
    }

    function updateLegend() {
      if (legendControl) map.removeControl(legendControl);
      const entries = Array.from(new Set(allPoints.map(p => p.sales_rep || 'Unassigned'))).sort();
      legendControl = L.control({ position: 'bottomright' });
      legendControl.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<b>Sales Rep / Territory</b>';
        entries.forEach(rep => {
          const color = colorForRep(rep);
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<span class="swatch" style="background:${color}"></span><span>${rep}</span>`;
          div.appendChild(row);
        });
        return div;
      };
      legendControl.addTo(map);
    }

    function populateRepFilter(points) {
      const reps = Array.from(new Set(points.map(p => p.sales_rep || 'Unassigned'))).sort();
      repFilter.innerHTML = `<option value="__ALL__">All</option>` + reps.map(r => `<option>${r}</option>`).join('');
    }

    function populateStateFilter(points) {
      const states = Array.from(new Set(points.map(p => p.state).filter(Boolean))).sort();
      stateFilter.innerHTML = `<option value="__ALL__">All</option>` + states.map(s => `<option value="${s}">${s}</option>`).join('');
      countyFilter.innerHTML = `<option value="__ALL__">All</option>`;
      countyFilter.disabled = true;
    }

    function populateCountyFilter(points, stateCode) {
      const counties = Array.from(new Set(points.filter(p => p.state === stateCode).map(p => p.county).filter(Boolean))).sort();
      countyFilter.innerHTML = `<option value="__ALL__">All</option>` + counties.map(c => `<option value="${c}">${c}</option>`).join('');
      countyFilter.disabled = false;
    }

    fetch('{{ url_for("api_locations") }}')
      .then(r => r.json())
      .then(points => {
        allPoints = points || [];
        populateRepFilter(allPoints);
        populateStateFilter(allPoints);
        render();
      })
      .catch(err => {
        console.error(err);
        alert('Could not load locations:\n' + err.message);
      });

    repFilter.addEventListener('change', render);
    segFilter.addEventListener('change', render);
    zipFilter.addEventListener('input', () => {
      clearTimeout(zipFilter._t);
      zipFilter._t = setTimeout(render, 200);
    });
    stateFilter.addEventListener('change', () => {
      const st = stateFilter.value;
      if (st === '__ALL__') {
        countyFilter.innerHTML = `<option value="__ALL__">All</option>`;
        countyFilter.disabled = true;
      } else {
        populateCountyFilter(allPoints, st);
      }
      render();
    });
    countyFilter.addEventListener('change', render);
    heatToggle.addEventListener('change', render);

    // ✅ AI Button Logic
function addAIButtonToPopup(marker, customerName) {
    marker.bindPopup(`
      <b>${customerName}</b><br/>
      <button onclick="runMapAI('${customerName.replace(/'/g, "\\'")}')">Run AI Analysis</button>
    `);
  }
  
  function runMapAI(customerName) {
    const sidebar = document.createElement("div");
    sidebar.className = "ai-popup";
    sidebar.innerHTML = `
      <div class="ai-header">
        <strong>AI Insights</strong>
        <button onclick="this.parentElement.parentElement.remove()">×</button>
      </div>
      <div class="ai-content">Loading insights for <b>${customerName}</b>...</div>
    `;
    document.body.appendChild(sidebar);

    fetch("/api/ai_map_analysis", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ customer: customerName }),
    })
      .then((r) => r.json())
      .then((data) => {
        const content = sidebar.querySelector(".ai-content");
        if (data.result) {
          content.innerHTML = `<pre>${data.result}</pre>`;
        } else {
          content.innerHTML = `<div style="color:red">Error: ${data.error || 'No result returned'}</div>`;
        }
      })
      .catch((err) => {
        sidebar.querySelector(".ai-content").textContent = "Error: " + err.message;
      });
  }
</script>
</body>
</html>
