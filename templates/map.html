<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Map (Segment / Territory / Geo Filters)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --brand: #cc0000;
      --ink: #1f1f1f;
      --bg: #f7f7f8;
      --card: #ffffff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--ink); }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--card); border-bottom: 1px solid #e6e6e8;
      gap: 10px; flex-wrap: wrap;
    }
    .title { font-weight: 600; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls label { font-size: 13px; color:#333; display:flex; gap:6px; align-items:center; }
    .controls select, .controls input[type="text"] {
      padding: 6px 10px; border-radius: 8px; border:1px solid #d0d0d5; background:#fff; font-size:14px;
    }
    .controls a {
      padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; text-decoration:none; color: var(--ink);
    }
    .controls a:hover { border-color: var(--brand); color: var(--brand); }

    #map { height: calc(100vh - 60px); width: 100vw; }

    .legend {
      background: white; padding: 8px 10px; border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2); font: 12px/1.1 system-ui, sans-serif;
      max-height: 30vh; overflow: auto;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .swatch { width:14px; height:14px; border-radius:50%; border:1px solid #0002; }

    /* AI Insights sidebar card */
    .ai-popup {
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 420px;
      max-height: 80vh;
      padding: 18px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      z-index: 2147483647;
      overflow-y: auto;
      font-family: system-ui, sans-serif;
      display: none;
    }
    .ai-popup h3 { margin: 0 0 8px 0; font-size: 18px; color: var(--brand); }
    .ai-popup .close-btn {
      position: absolute;
      top: 6px;
      right: 10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #999;
    }
    .ai-popup .close-btn:hover { color: #333; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Customer Map</div>
    <div class="controls">
      <label>
        Territory
        <select id="repFilter">
          <option value="__ALL__">All</option>
        </select>
      </label>
      <label>
        Segment
        <select id="segFilter">
          <option value="__ALL__">All</option>
          <option value="A">A only</option>
          <option value="B">B only</option>
          <option value="C">C only</option>
          <option value="D">D only</option>
        </select>
      </label>
      <label>
        State
        <select id="stateFilter">
          <option value="__ALL__">All</option>
        </select>
      </label>
      <label>
        County
        <select id="countyFilter" disabled>
          <option value="__ALL__">All</option>
        </select>
      </label>
      <label>
        ZIP
        <input id="zipFilter" type="text" placeholder="Exact ZIP" size="8" />
      </label>
      <!-- Company name search -->
      <label>
        Company
        <input id="nameFilter" type="text" placeholder="Search company…" size="18" />
      </label>
      <label>
        <input type="checkbox" id="heatToggle"> Heatmap Mode
      </label>
      <a href="{{ url_for('home') }}" aria-label="Back to Chat">← Back to Chat</a>
    </div>
  </div>

  <div id="map"></div>

  <!-- AI Insights Sidebar Card -->
  <div id="aiContainer" class="ai-popup">
    <button class="close-btn" onclick="document.getElementById('aiContainer').style.display='none'">×</button>
    <h3>AI Insights</h3>
    <div id="aiContent">Loading...</div>
  </div>

  <script>
    const map = L.map('map', { scrollWheelZoom: true }).setView([39.8, -98.6], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const palette = [
      '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2',
      '#7f7f7f','#bcbd22','#17becf','#393b79','#637939','#8c6d31','#843c39',
      '#7b4173','#3182bd','#e6550d','#31a354','#756bb1','#969696'
    ];
    const repIndex = new Map();
    const colorForRep = (rep) => {
      if (!repIndex.has(rep)) repIndex.set(rep, repIndex.size % palette.length);
      return palette[repIndex.get(rep)];
    };

    let allPoints = [];
    let layerGroup = L.featureGroup().addTo(map);
    let legendControl;
    let heatLayer = null;

    const repFilter    = document.getElementById('repFilter');
    const segFilter    = document.getElementById('segFilter');
    const stateFilter  = document.getElementById('stateFilter');
    const countyFilter = document.getElementById('countyFilter');
    const zipFilter    = document.getElementById('zipFilter');
    const nameFilter   = document.getElementById('nameFilter');
    const heatToggle   = document.getElementById('heatToggle');

    // === NEW: toggle visited helper (calls backend and refreshes) ===
    window.toggleVisited = async function(key, current) {
      try {
        const res = await fetch('/api/visit/mark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key, visited: !current })
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || res.statusText);
        // update local cache and re-render
        allPoints = (allPoints || []).map(p =>
          p.visit_key === key ? { ...p, visited: data.visited } : p
        );
        render();
      } catch (e) {
        alert('Could not save visit status: ' + e.message);
      }
    };

    function markerStyle(rep, visited=false) {
      const base = colorForRep(rep || 'Unassigned');
      return {
        radius: 7,
        weight: 1,
        color: visited ? '#666' : '#333',
        fillColor: base,
        fillOpacity: visited ? 0.35 : 0.9
      };
    }

    // ---------- SEGMENT LOOKUP (from /api/segments) ----------
    let SEG_INDEX = { by_exact:{}, by_norm:{}, by_norm_zip:{}, by_norm_city_state:{} };

    function normCompanyName(s) {
      if (!s) return '';
      s = s.toLowerCase();
      s = s.replace(/\b(inc|inc\.|llc|l\.l\.c\.|co|co\.|corp|corporation|company|ltd|ltd\.|lp|plc)\b/gi, '');
      s = s.replace(/[^a-z0-9]+/g, ' ');
      s = s.replace(/\s+/g, ' ').trim();
      return s;
    }
    function normCity(s) {
      return (s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').replace(/\s+/g, ' ').trim();
    }
    function zip5(z) {
      const m = String(z||'').match(/\d{5}/);
      return m ? m[0] : '';
    }
    function lookupSegmentForPoint(p) {
      const name  = p.company || p.label || ''; // prefer company
      const city  = p.city || '';
      const state = (p.state || '').toUpperCase();
      const z5    = zip5(p.zip);

      if (SEG_INDEX.by_exact[name]) return SEG_INDEX.by_exact[name];

      const n = normCompanyName(name);
      if (!n) return '';

      if (z5 && SEG_INDEX.by_norm_zip[`${n}|${z5}`]) return SEG_INDEX.by_norm_zip[`${n}|${z5}`];

      const nc = normCity(city);
      if (nc && state && SEG_INDEX.by_norm_city_state[`${n}|${nc}|${state}`])
        return SEG_INDEX.by_norm_city_state[`${n}|${nc}|${state}`];

      if (SEG_INDEX.by_norm[n]) return SEG_INDEX.by_norm[n];

      return p.segment || '';
    }

    function deriveFields(p) {
      const company = p.company || p.Company || p['Sold to Name'] || p['Ship to Name'] || '';
      const label = company || p.label || 'Unknown';

      // County/State like "Greene IN"
      let state = p.state || p.State || '';
      let county = p.county || p.County || '';
      const countyStateRaw = p['County State'] || p.county_state || '';
      if ((!county || !state) && countyStateRaw) {
        const parts = String(countyStateRaw).trim().split(/\s+/);
        if (parts.length >= 2) {
          state  = state  || parts[parts.length - 1];
          county = county || parts.slice(0, -1).join(' ');
        }
      }

      const address = p.Address || p.address || '';
      const city    = p.City    || p.city    || '';
      const zip     = String(p['Zip Code'] || p.zip || '').trim();

      const full_address = [address, [city, state].filter(Boolean).join(', '), zip, 'USA']
        .filter(Boolean).join(', ');

      const sales_rep = p.sales_rep || p['Sales Rep Name'] || 'Unassigned';

      // coords sanity
      let lat = p.lat, lon = p.lon;
      lat = lat == null ? null : parseFloat(lat);
      lon = lon == null ? null : parseFloat(lon);
      if (!(Number.isFinite(lat) && Number.isFinite(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180)) {
        lat = null; lon = null;
      }

      // contact passthrough
      const first_name = p.first_name || p['First Name'] || '';
      const last_name  = p.last_name  || p['Last Name']  || '';
      const job_title  = p.job_title  || p['Job Title']  || '';
      const phone      = p.phone      || p['Phone']      || '';
      const mobile     = p.mobile     || p['Mobile']     || '';
      const email      = p.email      || p['Email']      || '';

      // visited support: pass through if present
      const visited   = !!p.visited;
      const visit_key = p.visit_key || null;

      return {
        company, label, full_address, address, city, state, county, zip,
        sales_rep, segment: '', lat, lon,
        // contact
        first_name, last_name, job_title, phone, mobile, email,
        // visit
        visited, visit_key
      };
    }

    function withinRepFilter(pt) {
      const want = repFilter.value;
      return want === '__ALL__' || (pt.sales_rep || 'Unassigned') === want;
    }

    function withinSegFilter(pt) {
      const want = segFilter.value;
      if (want === '__ALL__') return true;
      const seg = lookupSegmentForPoint(pt) || '';
      return seg.startsWith(want);
    }

    function withinStateCountyZip(pt) {
      const st = stateFilter.value;
      if (st !== '__ALL__' && (pt.state || '') !== st) return false;

      const cy = countyFilter.value;
      if (!countyFilter.disabled && cy !== '__ALL__' && (pt.county || '') !== cy) return false;

      const z = zipFilter.value.trim();
      if (z && (pt.zip || '') !== z) return false;

      return true;
    }

    // name filter
    function withinNameFilter(pt) {
      const q = (nameFilter.value || '').trim().toLowerCase();
      if (!q) return true;
      return (pt.label || '').toLowerCase().includes(q);
    }

    // ===== AI sidebar formatting helpers & function =====
    function fmtMoney(n) {
      try { return Number(n).toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }); }
      catch { return `$${(n||0).toLocaleString()}`; }
    }
    function renderMetricsTable(metrics) {
      if (!metrics || typeof metrics !== 'object') return '';
      const rows = Object.entries(metrics)
        .map(([k,v]) => [k, Number(v||0)])
        .filter(([,v]) => v > 0)
        .sort((a,b) => b[1]-a[1]); // biggest first
      if (!rows.length) return '';
      const tr = rows.map(([k,v]) => `<tr><td>${k}</td><td class="num">${fmtMoney(v)}</td></tr>`).join('');
      return `
        <div class="ai-metrics">
          <table>
            <thead><tr><th>Metric</th><th class="num">Amount</th></tr></thead>
            <tbody>${tr}</tbody>
          </table>
        </div>
      `;
    }
    function renderAnalysisText(text) {
      if (!text || !text.trim()) return '';
      let t = text.replace(/^Customer:.*$/mi, '')
                  .replace(/^Key financial metrics:.*$/mi, '')
                  .trim();
      const lines = t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const bullets = lines.filter(s => s.startsWith('- ')).map(s => s.slice(2));
      const nonBullets = lines.filter(s => !s.startsWith('- '));
      const paras = nonBullets.length ? `<p>${nonBullets.join(' ')}</p>` : '';
      const ul = bullets.length ? `<ul>${bullets.map(x => `<li>${x}</li>`).join('')}</ul>` : '';
      return `${paras}${ul}`;
    }
    (function ensureAICss(){
      if (document.getElementById('ai-css')) return;
      const css = `
        #aiContainer { font-family: system-ui, sans-serif; }
        #aiContainer .ai-header { margin:0 0 6px 0; font-size:16px; font-weight:600; color:#222; }
        #aiContainer .ai-sub    { margin:0 0 10px 0; color:#666; font-size:12px; }
        #aiContainer .ai-metrics table { width:100%; border-collapse: collapse; margin: 6px 0 10px; }
        #aiContainer .ai-metrics th, #aiContainer .ai-metrics td { padding:6px 8px; border-bottom:1px solid #eee; font-size:12px; }
        #aiContainer .ai-metrics td.num, #aiContainer .ai-metrics th.num { text-align:right; white-space:nowrap; }
        #aiContainer ul { margin: 6px 0 0 18px; padding:0; }
        #aiContainer li { margin: 4px 0; }
      `;
      const el = document.createElement('style');
      el.id = 'ai-css';
      el.textContent = css;
      document.head.appendChild(el);
    })();

    // Global so inline onclick can call it
    window.askAIAboutCustomer = async function(name, city, zip, address, state) {
      const container = document.getElementById('aiContainer');
      const content = document.getElementById('aiContent');
      const heading = document.querySelector('#aiContainer h3');

      container.style.display = 'block';
      if (heading) heading.textContent = 'AI Insights';
      content.innerHTML = `<p class="ai-sub"><em>Analyzing <b>${name || 'Unknown'}</b>…</em></p>`;

      try {
        const res = await fetch('/api/ai_map_analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customer: name || '', city, zip, address, state })
        });
        const data = await res.json();

        const rawText = (data.response ?? data.result ?? '').toString();
        const metricsHtml = renderMetricsTable(data.metrics);
        const analysisHtml = renderAnalysisText(rawText);

        const headerHtml = `
          <div class="ai-header">${name || 'Unknown Customer'}</div>
          <div class="ai-sub">
            ${[city, state, zip].filter(Boolean).join(' • ')}
            ${data.segment ? ` • Segment: <b>${data.segment}</b>` : ''}
            ${data.aggregated ? ' • Aggregated (Sold-to group)' : ''}
          </div>
        `;

        content.innerHTML = headerHtml + metricsHtml + (analysisHtml || '<p>No narrative available.</p>');
      } catch (err) {
        content.innerHTML = `<p><strong>Network Error:</strong> ${err.message}</p>`;
      }
    };

    function render() {
      layerGroup.clearLayers();
      if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
      }

      const derived = (allPoints || []).map(deriveFields)
        .filter(p => p.lat != null && p.lon != null);

      const toShow = derived.filter(p =>
        withinRepFilter(p) &&
        withinSegFilter(p) &&
        withinStateCountyZip(p) &&
        withinNameFilter(p)
      );

      if (heatToggle.checked) {
        const heatPoints = toShow.map(p => [p.lat, p.lon, 1]);
        heatLayer = L.heatLayer(heatPoints, { radius: 25 }).addTo(map);
      } else {
        const group = L.featureGroup();
        toShow.forEach(p => {
          const style = markerStyle(p.sales_rep, !!p.visited);
          const segFull = p.segment || lookupSegmentForPoint(p) || '-';

          // Contact block
          const contactBits = [];
          const nameLine = [p.first_name, p.last_name].filter(Boolean).join(' ');
          if (nameLine) contactBits.push(nameLine);
          if (p.job_title) contactBits.push(p.job_title);
          if (p.phone)  contactBits.push(`Phone: <a href="tel:${p.phone}">${p.phone}</a>`);
          if (p.mobile) contactBits.push(`Mobile: <a href="tel:${p.mobile}">${p.mobile}</a>`);
          if (p.email)  contactBits.push(`<a href="mailto:${p.email}">${p.email}</a>`);
          const contactBlock = contactBits.length
            ? `<div style="margin-top:6px;">
                 <div style="font-weight:700;color:#7b4f1b;">Primary Contact:</div>
                 <div>${contactBits.join('<br>')}</div>
               </div>`
            : '';

          const escapedCompany = (p.company || p.label || '').replace(/'/g, "\\'");
          const escapedCity    = (p.city || '').replace(/'/g, "\\'");
          const escapedZip     = (p.zip  || '').replace(/'/g, "\\'");
          const escapedAddr    = (p.address || '').replace(/'/g, "\\'");
          const escapedState   = (p.state || '').replace(/'/g, "\\'");

          const visitBtn = p.visit_key ? `
              <button
                type="button"
                style="padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;margin-left:8px"
                onclick="toggleVisited('${p.visit_key}', ${p.visited ? 'true' : 'false'})">
                ${p.visited ? 'Unmark visited' : 'Mark as visited'}
              </button>` : '';

          const popupHtml = `
            <div style="font:14px/1.35 system-ui, sans-serif;">
              <div style="font-weight:700;">${p.company || p.label}</div>
              <div>${p.full_address}</div>
              <div>${p.sales_rep || 'Unassigned'}</div>
              <div>State: ${p.state || '-'} | County: ${p.county || '-'} | ZIP: ${p.zip || '-'}</div>
              <div>Segment: ${segFull}${p.visited ? ' • <span style="color:#2a7;">Visited</span>' : ''}</div>
              ${contactBlock}
              <div style="margin-top:8px">
                <button
                  type="button"
                  style="padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer"
                  onclick="askAIAboutCustomer('${escapedCompany}','${escapedCity}','${escapedZip}','${escapedAddr}','${escapedState}')">
                  AI Analysis
                </button>
                ${visitBtn}
              </div>
            </div>
          `;

          L.circleMarker([p.lat, p.lon], style).bindPopup(popupHtml).addTo(group);
        });
        group.addTo(layerGroup);

        if (toShow.length) {
          map.fitBounds(group.getBounds().pad(0.2));
        }

        updateLegend(derived);
      }
    }

    function updateLegend(derivedPoints) {
      if (legendControl) map.removeControl(legendControl);
      const entries = Array.from(new Set(derivedPoints.map(p => p.sales_rep || 'Unassigned'))).sort();
      legendControl = L.control({ position: 'bottomright' });
      legendControl.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<b>Sales Rep / Territory</b>';
        entries.forEach(rep => {
          const color = colorForRep(rep);
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<span class="swatch" style="background:${color}"></span><span>${rep}</span>`;
          div.appendChild(row);
        });
        return div;
      };
      legendControl.addTo(map);
    }

    function populateRepFilter(points) {
      const reps = Array.from(new Set(points.map(p => (p.sales_rep || p['Sales Rep Name'] || 'Unassigned')))).sort();
      repFilter.innerHTML = `<option value="__ALL__">All</option>` + reps.map(r => `<option>${r}</option>`).join('');
    }

    function populateStateFilter(points) {
      const states = Array.from(new Set(points.map(p => (p.state || p.State || (String(p['County State']||'').trim().split(/\s+/).pop()) )).filter(Boolean))).sort();
      stateFilter.innerHTML = `<option value="__ALL__">All</option>` + states.map(s => `<option value="${s}">${s}</option>`).join('');
      countyFilter.innerHTML = `<option value="__ALL__">All</option>`;
      countyFilter.disabled = true;
    }

    function populateCountyFilter(points, stateCode) {
      const counties = Array.from(new Set(points.map(p => {
        let county = p.county || p.County || '';
        if (!county && p['County State']) {
          const parts = String(p['County State']).trim().split(/\s+/);
          if (parts.length >= 2) county = parts.slice(0, -1).join(' ');
        }
        const pState = p.state || p.State || (String(p['County State']||'').trim().split(/\s+/).pop());
        return (pState === stateCode) ? county : null;
      }).filter(Boolean))).sort();
      countyFilter.innerHTML = `<option value="__ALL__">All</option>` + counties.map(c => `<option value="${c}">${c}</option>`).join('');
      countyFilter.disabled = false;
    }

    // --------- INITIAL LOAD: segments then locations ----------
    Promise.all([
      fetch('{{ url_for("api_segments") }}').then(r => r.json()).then(idx => { SEG_INDEX = idx || SEG_INDEX; }),
      fetch('{{ url_for("api_locations") }}').then(r => r.json())
    ])
    .then(([, points]) => {
      allPoints = points || [];
      populateRepFilter(allPoints);
      populateStateFilter(allPoints);
      render();
    })
    .catch(err => {
      console.error(err);
      alert('Could not load data:\n' + err.message);
    });

    // Events
    repFilter.addEventListener('change', render);
    segFilter.addEventListener('change', render);
    zipFilter.addEventListener('input', () => {
      clearTimeout(zipFilter._t);
      zipFilter._t = setTimeout(render, 200);
    });
    nameFilter.addEventListener('input', () => {
      clearTimeout(nameFilter._t);
      nameFilter._t = setTimeout(render, 200);
    });
    stateFilter.addEventListener('change', () => {
      const st = stateFilter.value;
      if (st === '__ALL__') {
        countyFilter.innerHTML = `<option value="__ALL__">All</option>`;
        countyFilter.disabled = true;
      } else {
        populateCountyFilter(allPoints, st);
      }
      render();
    });
    countyFilter.addEventListener('change', render);
    heatToggle.addEventListener('change', render);
  </script>
</body>
</html>
