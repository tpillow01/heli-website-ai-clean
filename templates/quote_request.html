<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>HELI Quote Request - Tynan Equipment AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='ymfix1') }}">
</head>
<body class="quote-request-page">
<div class="app-shell">

    <header class="top-header qr-brand-header">
    <div class="header-left">
        <div class="app-title qr-brand-title">Tynan Equipment AI</div>
    </div>

    <div class="header-center">
        <nav class="tabs qr-brand-tabs">
            <a href="{{ url_for('home') }}" class="tab">Chat</a>
            <a href="{{ url_for('map_page') }}" class="tab">Map</a>
            <a href="/battlecards"
               class="tab {{ 'active' if request.path.startswith('/battlecards') else '' }}">
                Battle Cards
            </a>
            <a href="{{ url_for('quote_request') }}" class="tab active">Quote Request</a>
            <a href="{{ url_for('logout') }}" class="tab">Logout</a>
        </nav>
    </div>

    <div class="header-right">
        <div class="qr-brand-heli">HELI</div>
    </div>
</header>

    <main class="quote-request-main">
        <div class="quote-request-container">
            <section class="quote-request-card">
                <h1 class="quote-request-title">HELI Quote Request</h1>
                <p class="quote-request-subtitle">
                    Fill out every field below to generate a clean PDF for Lisa.
                </p>

                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                    <div class="flash-wrap">
                      {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}

                <div id="mobileSaveHint" style="display:none; margin-top:12px;">
                    <div class="qr-hint">
                        Mobile tip: after the PDF opens, tap <strong>Share</strong> â†’ <strong>Save to Files</strong> (iPhone)
                        or <strong>Download</strong>/<strong>Save to Drive</strong> (Android).
                    </div>
                </div>

                <form id="quoteRequestForm" method="post" action="{{ url_for('quote_request') }}"
                      class="quote-request-form" novalidate>
                    <div class="quote-request-grid">

                        <div class="qr-group qr-group-full">
                            <label for="customer_name">Customer Name</label>
                            <div class="qr-hint">Company Name</div>
                            <input type="text" id="customer_name" name="customer_name" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="address">Address</label>
                            <div class="qr-hint">Company Address</div>
                            <input type="text" id="address" name="address" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="city_state_zip">City / State / Zip</label>
                            <div class="qr-hint">City, State, Zip</div>
                            <input type="text" id="city_state_zip" name="city_state_zip" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="contact_name">Contact Name (First &amp; Last)</label>
                            <div class="qr-hint">Primary contact at the company</div>
                            <input type="text" id="contact_name" name="contact_name" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="model">Model</label>
                            <div class="qr-hint">Please check stock list first</div>
                            <input type="text" id="model" name="model" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="fuel_type">Fuel</label>
                            <div class="qr-hint">LPG, Diesel, Electric, or Dual Fuel</div>
                            <select id="fuel_type" name="fuel_type" class="qr-select" required>
                                <option value="" disabled selected>Select fuel type</option>
                                {% for option in fuel_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group" id="battery_voltage_group">
                            <label for="battery_voltage">Battery Voltage</label>
                            <div class="qr-hint">Required if fuel is Electric (e.g. 24V, 36V, 48V)</div>
                            <input type="text" id="battery_voltage" name="battery_voltage" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="mast_ohl_mfh">Mast OHL / MFH</label>
                            <div class="qr-hint">Enter maximum fork height</div>
                            <input type="text" id="mast_ohl_mfh" name="mast_ohl_mfh" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="mast_type">Mast Type</label>
                            <div class="qr-hint">Simplex, Duplex, Triplex, or Quad</div>
                            <select id="mast_type" name="mast_type" class="qr-select" required>
                                <option value="" disabled selected>Select mast type</option>
                                {% for option in mast_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="attachment">Attachment</label>
                            <div class="qr-hint">SS, SSFP, Bale Clamp etc... (type "None" if no attachment)</div>
                            <input type="text" id="attachment" name="attachment" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="aux_valve">Auxiliary Control Valve</label>
                            <select id="aux_valve" name="aux_valve" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="aux_hose">Auxiliary Hose Take Up</label>
                            <select id="aux_hose" name="aux_hose" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="fork_type">Fork Type</label>
                            <div class="qr-hint">Standard, Hinged Fork, etc.</div>
                            <input type="text" id="fork_type" name="fork_type" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="fork_length">Fork Length</label>
                            <div class="qr-hint">42 in, 48 in, etc.</div>
                            <input type="text" id="fork_length" name="fork_length" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="tires">Tire</label>
                            <div class="qr-hint">
                                Cushion Standard, Cushion Non Marking, Cushion Non Marking Traction,
                                Smooth, Solid Pneumatic, Pneumatic
                            </div>
                            <select id="tires" name="tires" class="qr-select" required>
                                <option value="" disabled selected>Select tires</option>
                                {% for option in tire_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="seat_suspension">Seat Suspension</label>
                            <select id="seat_suspension" name="seat_suspension" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- MUST be headlights to match heli_backup_ai.py + quote_request_pdf.py -->
                        <div class="qr-group">
                            <label for="headlights">Front Work Lights</label>
                            <select id="headlights" name="headlights" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="back_up_alarm">Backup Alarm</label>
                            <select id="back_up_alarm" name="back_up_alarm" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="strobe">Strobe</label>
                            <select id="strobe" name="strobe" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rear_work_light">Rear Work Light</label>
                            <select id="rear_work_light" name="rear_work_light" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="blue_light_front">Blue Light Front</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="blue_light_front" name="blue_light_front" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="blue_light_rear">Blue Light Rear</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="blue_light_rear" name="blue_light_rear" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="red_curtain_lights">Red Curtain Lights</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="red_curtain_lights" name="red_curtain_lights" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="battery">Battery</label>
                            <div class="qr-hint">Lithium, Lead Acid, None, etc.</div>
                            <select id="battery" name="battery" class="qr-select" required>
                                <option value="" disabled selected>Select battery</option>
                                {% for option in battery_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="charger">Charger</label>
                            <div class="qr-hint">Standard if the truck is electric; otherwise type "None"</div>
                            <input type="text" id="charger" name="charger" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="local_options">Local Options</label>
                            <div class="qr-hint">Paint, Fan, Computer Holder, Cup Holder etc. (type "None" if no local options)</div>
                            <input type="text" id="local_options" name="local_options" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="expected_delivery">Customer Requested Delivery</label>
                            <div class="qr-hint">Use "-" if unknown</div>
                            <input type="text" id="expected_delivery" name="expected_delivery" class="qr-input" value="-" required />
                        </div>

                        <div class="qr-group">
                            <label for="lease_type">Lease Type</label>
                            <div class="qr-hint">FMV or FPO</div>
                            <select id="lease_type" name="lease_type" class="qr-select" required>
                                <option value="" disabled selected>Select lease type</option>
                                {% for option in lease_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="annual_hours">Annual Hours</label>
                            <div class="qr-hint">Ask customer how many hours they use a year</div>
                            <input type="number" id="annual_hours" name="annual_hours" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="lease_term">Lease Term (Months)</label>
                            <div class="qr-hint">Ask customer how many months they would like to lease</div>
                            <input type="number" id="lease_term" name="lease_term" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="notes">Notes</label>
                            <div class="qr-hint">Customer special requirements</div>
                            <textarea id="notes" name="notes" class="qr-textarea" required></textarea>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="salesperson_name">Salesperson Name</label>
                            <div class="qr-hint">Your name</div>
                            <input type="text" id="salesperson_name" name="salesperson_name" class="qr-input" required />
                        </div>
                    </div>

                    <div class="qr-actions">
                        <button id="btnGeneratePdf" type="submit" class="primary-button">
                            Generate Quote Request PDF
                        </button>
                    </div>
                </form>

            </section>
        </div>
    </main>
</div>

<script>
    // Fuel -> battery voltage requirement
    const fuelSelect = document.getElementById('fuel_type');
    const voltageGroup = document.getElementById('battery_voltage_group');
    const voltageInput = document.getElementById('battery_voltage');

    function updateVoltageVisibility() {
        if (!fuelSelect || !voltageGroup || !voltageInput) return;
        const isElectric = fuelSelect.value === 'Electric';
        if (isElectric) {
            voltageGroup.style.display = 'block';
            voltageInput.setAttribute('required', 'required');
        } else {
            voltageGroup.style.display = 'none';
            voltageInput.removeAttribute('required');
            voltageInput.value = '';
        }
    }

    if (fuelSelect) {
        updateVoltageVisibility();
        fuelSelect.addEventListener('change', updateVoltageVisibility);
    }

    // Mobile Share/Save behavior (desktop stays EXACTLY the same)
    (function () {
        const form = document.getElementById("quoteRequestForm");
        const btn = document.getElementById("btnGeneratePdf");
        const hint = document.getElementById("mobileSaveHint");
        if (!form || !btn) return;

        const ua = navigator.userAgent || "";
        const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);

        if (!isMobile) {
            // Desktop: do nothing; normal submit -> normal download
            if (hint) hint.style.display = "none";
            return;
        }

        if (hint) hint.style.display = "block";

        form.addEventListener("submit", async (e) => {
            // Mobile: intercept submit and try to open native Share sheet
            e.preventDefault();

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Generating PDF...";

            try {
                const formData = new FormData(form);

                const res = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "fetch",
                        "Accept": "application/pdf"
                    }
                });

                const contentType = (res.headers.get("content-type") || "").toLowerCase();

                if (!res.ok || !contentType.includes("application/pdf")) {
                    const msg = await res.text().catch(() => "");
                    throw new Error(msg || `PDF generation failed (${res.status}).`);
                }

                const blob = await res.blob();

                // Try filename from header
                const dispo = res.headers.get("content-disposition") || "";
                const match = dispo.match(/filename="(.+?)"/);
                const filename = match ? match[1] : "heli_quote_request.pdf";

                const file = new File([blob], filename, { type: "application/pdf" });

                // Best case: native share sheet with the PDF attached
                if (navigator.canShare && navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: "HELI Quote Request",
                        text: "Quote request PDF",
                        files: [file],
                    });
                    return;
                }

                // Fallback: open PDF in a new tab so user can use browser Share/Save
                const url = URL.createObjectURL(blob);
                window.open(url, "_blank");
                setTimeout(() => URL.revokeObjectURL(url), 30000);

            } catch (err) {
                alert(err?.message || "Failed to generate/share the PDF.");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    })();
</script>
</body>
</html>
