<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>HELI Request Forms - Tynan Equipment AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v='qrbrand2_forms_v3_used') }}">
</head>

<body class="quote-request-page">
<div class="app-shell">

<header class="top-header qr-brand-header">
    <div class="header-left">
        <div class="app-title qr-brand-title">Tynan Equipment AI</div>
    </div>

    <div class="header-center">
        <nav class="tabs qr-brand-tabs">
            <a href="{{ url_for('home') }}" class="tab">Chat</a>
            <a href="{{ url_for('map_page') }}" class="tab">Map</a>
            <a href="/battlecards"
               class="tab {{ 'active' if request.path.startswith('/battlecards') else '' }}">
                Battle Cards
            </a>
            <a href="{{ url_for('quote_request') }}" class="tab active">Quote Request</a>
            <a href="{{ url_for('logout') }}" class="tab">Logout</a>
        </nav>
    </div>

    <div class="header-right">
        <div class="qr-brand-heli">HELI</div>
    </div>
</header>

<main class="quote-request-main">
    <div class="quote-request-container">
        <section class="quote-request-card">
            <h1 id="pageTitle" class="quote-request-title">HELI Quote Request</h1>
            <p id="pageSubtitle" class="quote-request-subtitle">
                Fill out every field below to generate a clean PDF for Lisa.
            </p>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="flash-wrap">
                  {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <div id="mobileSaveHint" style="display:none; margin-top:12px;">
                <div class="qr-hint">
                    Mobile tip: after the PDF opens, tap <strong>Share</strong> → <strong>Save to Files</strong> (iPhone)
                    or <strong>Download</strong>/<strong>Save to Drive</strong> (Android).
                </div>
            </div>

            <!-- Request Type Selector -->
            <div class="qr-group qr-group-full" style="margin-top:16px;">
                <label for="request_type_select">Select Request Type</label>
                <div class="qr-hint">Switch forms without leaving the page</div>
                <select id="request_type_select" class="qr-select">
                    <option value="quote" selected>Quote Request</option>
                    <option value="demo">Demo Request</option>
                    <option value="rental">Rental Request</option>
                    <option value="used">Used Equipment Request</option>
                </select>
            </div>

            <!-- ========================= -->
            <!-- QUOTE REQUEST (EXISTING)  -->
            <!-- ========================= -->
            <div id="form_wrap_quote" class="request-form-wrap">
                <form id="quoteRequestForm"
                      method="post"
                      action="{{ url_for('quote_request') }}"
                      class="quote-request-form"
                      novalidate
                      data-request-type="quote"
                      data-pdf-title="HELI Quote Request">

                    <input type="hidden" name="request_type" value="quote" />

                    <div class="quote-request-grid">

                        <div class="qr-group qr-group-full">
                            <label for="customer_name">Customer Name</label>
                            <div class="qr-hint">Company Name</div>
                            <input type="text" id="customer_name" name="customer_name" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="address">Address</label>
                            <div class="qr-hint">Company Address</div>
                            <input type="text" id="address" name="address" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="city_state_zip">City / State / Zip</label>
                            <div class="qr-hint">City, State, Zip</div>
                            <input type="text" id="city_state_zip" name="city_state_zip" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="contact_name">Contact Name (First &amp; Last)</label>
                            <div class="qr-hint">Primary contact at the company</div>
                            <input type="text" id="contact_name" name="contact_name" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="model">Model</label>
                            <div class="qr-hint">Please check stock list first</div>
                            <input type="text" id="model" name="model" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="fuel_type">Fuel</label>
                            <div class="qr-hint">LPG, Diesel, Electric, or Dual Fuel</div>
                            <select id="fuel_type" name="fuel_type" class="qr-select" required>
                                <option value="" disabled selected>Select fuel type</option>
                                {% for option in fuel_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group" id="battery_voltage_group">
                            <label for="battery_voltage">Battery Voltage</label>
                            <div class="qr-hint">Required if fuel is Electric (e.g. 24V, 36V, 48V)</div>
                            <input type="text" id="battery_voltage" name="battery_voltage" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="mast_ohl_mfh">Mast OHL / MFH</label>
                            <div class="qr-hint">Enter lowered and maximum fork height</div>
                            <input type="text" id="mast_ohl_mfh" name="mast_ohl_mfh" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="mast_type">Mast Type</label>
                            <div class="qr-hint">Simplex, Duplex, Triplex, or Quad</div>
                            <select id="mast_type" name="mast_type" class="qr-select" required>
                                <option value="" disabled selected>Select mast type</option>
                                {% for option in mast_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="attachment">Attachment</label>
                            <div class="qr-hint">SS, SSFP, Bale Clamp etc... (type "None" if no attachment)</div>
                            <input type="text" id="attachment" name="attachment" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="aux_valve">Auxiliary Control Valve</label>
                            <select id="aux_valve" name="aux_valve" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="aux_hose">Auxiliary Hose Take Up</label>
                            <select id="aux_hose" name="aux_hose" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="fork_type">Fork Type</label>
                            <div class="qr-hint">Standard, Hinged Fork, etc.</div>
                            <input type="text" id="fork_type" name="fork_type" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="fork_length">Fork Length</label>
                            <div class="qr-hint">42 in, 48 in, etc.</div>
                            <input type="text" id="fork_length" name="fork_length" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="tires">Tire</label>
                            <div class="qr-hint">
                                Cushion Standard, Cushion Non Marking, Cushion Non Marking Traction,
                                Smooth, Solid Pneumatic, Pneumatic, Polyurethane
                            </div>
                            <select id="tires" name="tires" class="qr-select" required>
                                <option value="" disabled selected>Select tires</option>
                                {% for option in tire_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="seat_suspension">Seat Suspension</label>
                            <select id="seat_suspension" name="seat_suspension" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="headlights">Front Work Lights</label>
                            <select id="headlights" name="headlights" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="back_up_alarm">Backup Alarm</label>
                            <select id="back_up_alarm" name="back_up_alarm" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="strobe">Strobe</label>
                            <select id="strobe" name="strobe" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rear_work_light">Rear Work Light</label>
                            <select id="rear_work_light" name="rear_work_light" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="blue_light_front">Blue Light Front</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="blue_light_front" name="blue_light_front" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="blue_light_rear">Blue Light Rear</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="blue_light_rear" name="blue_light_rear" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="red_curtain_lights">Red Curtain Lights</label>
                            <div class="qr-hint">Additional charge if yes</div>
                            <select id="red_curtain_lights" name="red_curtain_lights" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="battery">Battery</label>
                            <div class="qr-hint">Lithium, Lead Acid, None, etc.</div>
                            <select id="battery" name="battery" class="qr-select" required>
                                <option value="" disabled selected>Select battery</option>
                                {% for option in battery_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="charger">Charger</label>
                            <div class="qr-hint">Standard if the truck is electric; otherwise type "None"</div>
                            <input type="text" id="charger" name="charger" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="local_options">Local Options</label>
                            <div class="qr-hint">Paint, Fan, Computer Holder, Cup Holder etc. (type "None" if no local options)</div>
                            <input type="text" id="local_options" name="local_options" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="expected_delivery">Customer Requested Delivery</label>
                            <div class="qr-hint">Use "-" if unknown</div>
                            <input type="text" id="expected_delivery" name="expected_delivery" class="qr-input" value="-" required />
                        </div>

                        <div class="qr-group">
                            <label for="lease_type">Lease Type</label>
                            <div class="qr-hint">FMV or FPO or Cash</div>
                            <select id="lease_type" name="lease_type" class="qr-select" required>
                                <option value="" disabled selected>Select lease type</option>
                                {% for option in lease_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="annual_hours">Annual Hours</label>
                            <div class="qr-hint">Ask customer how many hours they use a year</div>
                            <input type="number" id="annual_hours" name="annual_hours" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="lease_term">Lease Term (Months)</label>
                            <div class="qr-hint">Ask customer how many months they would like to lease</div>
                            <input type="number" id="lease_term" name="lease_term" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="notes">Notes</label>
                            <div class="qr-hint">Customer special requirements</div>
                            <textarea id="notes" name="notes" class="qr-textarea" required></textarea>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="salesperson_name">Salesperson Name</label>
                            <div class="qr-hint">Your name</div>
                            <input type="text" id="salesperson_name" name="salesperson_name" class="qr-input" required />
                        </div>
                    </div>

                    <div class="qr-actions">
                        <button type="submit" class="primary-button">
                            Generate Quote Request PDF
                        </button>
                    </div>
                </form>
            </div>

            <!-- ========================= -->
            <!-- DEMO REQUEST (UPDATED)    -->
            <!-- ========================= -->
            <div id="form_wrap_demo" class="request-form-wrap" style="display:none;">
                <form id="demoRequestForm"
                      method="post"
                      action="{{ url_for('quote_request') }}"
                      class="quote-request-form"
                      novalidate
                      data-request-type="demo"
                      data-pdf-title="HELI Demo Request">

                    <input type="hidden" name="request_type" value="demo" />

                    <div class="quote-request-grid">
                        <div class="qr-group">
                            <label for="demo_ordered_by">Ordered By</label>
                            <input type="text" id="demo_ordered_by" name="ordered_by" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="demo_company_name">Company Name</label>
                            <input type="text" id="demo_company_name" name="company_name" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="demo_ship_to_address">Ship To Address</label>
                            <input type="text" id="demo_ship_to_address" name="ship_to_address" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="demo_contact_name">Contact Name</label>
                            <input type="text" id="demo_contact_name" name="contact_name" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="demo_phone">Phone</label>
                            <input type="text" id="demo_phone" name="phone" class="qr-input" />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="demo_bill_to_address">Bill To Address</label>
                            <input type="text" id="demo_bill_to_address" name="bill_to_address" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="demo_company_phone_fax">Company Phone/Fax</label>
                            <input type="text" id="demo_company_phone_fax" name="company_phone_fax" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="demo_po_number">PO #</label>
                            <input type="text" id="demo_po_number" name="po_number" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="demo_cartage">Cartage</label>
                            <select id="demo_cartage" name="cartage" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="Dock">Dock</option>
                                <option value="Ground">Ground</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_quantity">Quantity</label>
                            <input type="number" id="demo_quantity" name="quantity" class="qr-input" min="1" />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="demo_description_model">Description / Model</label>
                            <input type="text" id="demo_description_model" name="description_model" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="demo_rate">Rate</label>
                            <select id="demo_rate" name="rate" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="demo_freight_charges">Freight Charges</label>
                            <div class="qr-hint">Please add $25 for each additional truck</div>
                            <input type="text" id="demo_freight_charges" name="freight_charges" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="demo_fork_length">Fork Length</label>
                            <input type="text" id="demo_fork_length" name="fork_length" class="qr-input" />
                        </div>

                        <div class="qr-group" id="demo_lbr_group">
                            <label for="demo_lbr">LBR</label>
                            <select id="demo_lbr" name="lbr" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_side_shifter">Side Shifter</label>
                            <select id="demo_side_shifter" name="side_shifter" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_backup_alarm">Back-up Alarm</label>
                            <select id="demo_backup_alarm" name="backup_alarm" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_work_lights">Work Lights</label>
                            <select id="demo_work_lights" name="headlights" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_tires">Tires</label>
                            <select id="demo_tires" name="tires" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in tire_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_power_type">LP or Gas / Electric</label>
                            <select id="demo_power_type" name="power_type" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="LP or Gas">LP or Gas</option>
                                <option value="Electric">Electric</option>
                            </select>
                        </div>

                        <div class="qr-group" id="demo_need_lp_tank_group">
                            <label for="demo_need_lp_tank">Need LP Tank</label>
                            <select id="demo_need_lp_tank" name="need_lp_tank" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="demo_mast_height">Mast Height</label>
                            <input type="text" id="demo_mast_height" name="mast_height" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="demo_mast_type">Mast Type</label>
                            <select id="demo_mast_type" name="mast_type" class="qr-select" required>
                                <option value="" disabled selected>Select mast type</option>
                                {% for option in mast_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="demo_electric_block" style="display:none;" class="qr-group qr-group-full">
                            <div class="quote-request-grid" style="margin-top:0;">
                                <div class="qr-group">
                                    <label for="demo_connector">Connector</label>
                                    <input type="text" id="demo_connector" name="connector" class="qr-input" />
                                </div>

                                <div class="qr-group">
                                    <label for="demo_need_charger">Need Charger</label>
                                    <select id="demo_need_charger" name="need_charger" class="qr-select">
                                        <option value="" selected>—</option>
                                        {% for option in yes_no_options %}
                                            <option value="{{ option }}">{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="qr-group">
                                    <label for="demo_input_volts">Input Volts</label>
                                    <input type="text" id="demo_input_volts" name="input_volts" class="qr-input" />
                                </div>

                                <div class="qr-group">
                                    <label for="demo_phase">Phase</label>
                                    <input type="text" id="demo_phase" name="phase" class="qr-input" />
                                </div>
                            </div>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="demo_special_instructions">Special Instructions</label>
                            <textarea id="demo_special_instructions" name="special_instructions" class="qr-textarea"></textarea>
                        </div>
                    </div>

                    <div class="qr-actions">
                        <button type="submit" class="primary-button">
                            Generate Demo Request PDF
                        </button>
                    </div>
                </form>
            </div>

            <!-- ========================= -->
            <!-- RENTAL REQUEST (UPDATED)  -->
            <!-- ========================= -->
            <div id="form_wrap_rental" class="request-form-wrap" style="display:none;">
                <form id="rentalRequestForm"
                      method="post"
                      action="{{ url_for('quote_request') }}"
                      class="quote-request-form"
                      novalidate
                      data-request-type="rental"
                      data-pdf-title="HELI Rental Request">

                    <input type="hidden" name="request_type" value="rental" />

                    <div class="quote-request-grid">
                        <div class="qr-group">
                            <label for="rental_ordered_by">Ordered By</label>
                            <input type="text" id="rental_ordered_by" name="ordered_by" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="rental_company_name">Company Name</label>
                            <input type="text" id="rental_company_name" name="company_name" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="rental_ship_to_address">Ship To Address</label>
                            <input type="text" id="rental_ship_to_address" name="ship_to_address" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="rental_contact_name">Contact Name</label>
                            <input type="text" id="rental_contact_name" name="contact_name" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="rental_phone">Phone</label>
                            <input type="text" id="rental_phone" name="phone" class="qr-input" />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="rental_bill_to_address">Bill To Address</label>
                            <input type="text" id="rental_bill_to_address" name="bill_to_address" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="rental_cartage">Cartage</label>
                            <select id="rental_cartage" name="cartage" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="Dock">Dock</option>
                                <option value="Ground">Ground</option>
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_company_phone_fax">Company Phone/Fax</label>
                            <input type="text" id="rental_company_phone_fax" name="company_phone_fax" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="rental_po_number">PO #</label>
                            <input type="text" id="rental_po_number" name="po_number" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="rental_quantity">Quantity</label>
                            <input type="number" id="rental_quantity" name="quantity" class="qr-input" min="1" />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="rental_description_model">Description / Model</label>
                            <input type="text" id="rental_description_model" name="description_model" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="rental_rate">Rate</label>
                            <select id="rental_rate" name="rate" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="rental_freight_charges">Freight Charges</label>
                            <div class="qr-hint">Please add $25 for each additional truck</div>
                            <input type="text" id="rental_freight_charges" name="freight_charges" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="rental_fork_length">Fork Length</label>
                            <input type="text" id="rental_fork_length" name="fork_length" class="qr-input" />
                        </div>

                        <div class="qr-group" id="rental_lbr_group">
                            <label for="rental_lbr">LBR</label>
                            <select id="rental_lbr" name="lbr" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_side_shifter">Side Shifter</label>
                            <select id="rental_side_shifter" name="side_shifter" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_backup_alarm">Back-up Alarm</label>
                            <select id="rental_backup_alarm" name="backup_alarm" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_work_lights">Work Lights</label>
                            <select id="rental_work_lights" name="headlights" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_tires">Tires</label>
                            <select id="rental_tires" name="tires" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in tire_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_power_type">LP or Gas / Electric</label>
                            <select id="rental_power_type" name="power_type" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="LP or Gas">LP or Gas</option>
                                <option value="Electric">Electric</option>
                            </select>
                        </div>

                        <div class="qr-group" id="rental_need_lp_tank_group">
                            <label for="rental_need_lp_tank">Need LP Tank</label>
                            <select id="rental_need_lp_tank" name="need_lp_tank" class="qr-select">
                                <option value="" selected>—</option>
                                {% for option in yes_no_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="rental_mast_height">Mast Height</label>
                            <input type="text" id="rental_mast_height" name="mast_height" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="rental_mast_type">Mast Type</label>
                            <select id="rental_mast_type" name="mast_type" class="qr-select" required>
                                <option value="" disabled selected>Select mast type</option>
                                {% for option in mast_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div id="rental_electric_block" style="display:none;" class="qr-group qr-group-full">
                            <div class="quote-request-grid" style="margin-top:0;">
                                <div class="qr-group">
                                    <label for="rental_connector">Connector</label>
                                    <input type="text" id="rental_connector" name="connector" class="qr-input" />
                                </div>

                                <div class="qr-group">
                                    <label for="rental_need_charger">Need Charger</label>
                                    <select id="rental_need_charger" name="need_charger" class="qr-select">
                                        <option value="" selected>—</option>
                                        {% for option in yes_no_options %}
                                            <option value="{{ option }}">{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="qr-group">
                                    <label for="rental_input_volts">Input Volts</label>
                                    <input type="text" id="rental_input_volts" name="input_volts" class="qr-input" />
                                </div>

                                <div class="qr-group">
                                    <label for="rental_phase">Phase</label>
                                    <input type="text" id="rental_phase" name="phase" class="qr-input" />
                                </div>
                            </div>
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="rental_special_instructions">Special Instructions</label>
                            <textarea id="rental_special_instructions" name="special_instructions" class="qr-textarea"></textarea>
                        </div>
                    </div>

                    <div class="qr-actions">
                        <button type="submit" class="primary-button">
                            Generate Rental Request PDF
                        </button>
                    </div>
                </form>
            </div>

            <!-- ========================= -->
            <!-- USED EQUIPMENT (FIXED)    -->
            <!-- ========================= -->
            <div id="form_wrap_used" class="request-form-wrap" style="display:none;">
                <form id="usedRequestForm"
                      method="post"
                      action="{{ url_for('quote_request') }}"
                      class="quote-request-form"
                      novalidate
                      data-request-type="used_equipment"
                      data-pdf-title="Used Equipment Request">

                    <input type="hidden" name="request_type" value="used_equipment" />

                    <div class="quote-request-grid">

                        <div class="qr-group qr-group-full">
                            <label for="used_customer_name">Customer</label>
                            <input type="text" id="used_customer_name" name="customer_name" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="used_address">Address</label>
                            <input type="text" id="used_address" name="address" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="used_city_zip">City and Zip Code</label>
                            <input type="text" id="used_city_zip" name="city_state_zip" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="used_contact_name">Contact Name</label>
                            <input type="text" id="used_contact_name" name="contact_name" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="used_model">Model</label>
                            <input type="text" id="used_model" name="model" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="used_fuel_type">Fuel Type</label>
                            <div class="qr-hint">Select LP, Gas, Diesel, or Electric</div>
                            <select id="used_fuel_type" name="fuel_type" class="qr-select" required>
                                <option value="" disabled selected>Select</option>
                                <option value="LP">LP</option>
                                <option value="Gas">Gas</option>
                                <option value="Diesel">Diesel</option>
                                <option value="Electric">Electric</option>
                            </select>
                        </div>

                        <div class="qr-group" id="used_voltage_group" style="display:none;">
                            <label for="used_voltage">Electric Voltage</label>
                            <select id="used_voltage" name="battery_voltage" class="qr-select">
                                <option value="" selected>—</option>
                                <option value="12V">12V</option>
                                <option value="24V">24V</option>
                                <option value="36V">36V</option>
                                <option value="48V">48V</option>
                                <option value="80V">80V</option>
                            </select>
                        </div>

                        <div class="qr-group" id="used_line_voltage_group" style="display:none;">
                            <label for="used_line_voltage">Line Voltage</label>
                            <input type="text" id="used_line_voltage" name="line_voltage" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="used_mast_height">Mast Height</label>
                            <input type="text" id="used_mast_height" name="mast_height" class="qr-input" required />
                        </div>

                        <div class="qr-group">
                            <label for="used_mast_type">Mast Type</label>
                            <select id="used_mast_type" name="mast_type" class="qr-select" required>
                                <option value="" disabled selected>Select mast type</option>
                                {% for option in mast_type_options %}
                                    <option value="{{ option }}">{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="qr-group">
                            <label for="used_fork_size">Fork Size</label>
                            <input type="text" id="used_fork_size" name="fork_size" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="used_budget_price">Customer Budget</label>
                            <input type="text" id="used_budget_price" name="budget_price" class="qr-input" />
                        </div>

                        <div class="qr-group">
                            <label for="used_lease_type">Lease Type</label>
                            <div class="qr-hint">FPO or Cash</div>
                            <select id="used_lease_type" name="lease_type" class="qr-select" required>
                                <option value="" disabled selected>Select lease type</option>
                                <option value="FPO">FPO</option>
                                <option value="Cash">Cash</option>
                            </select>
                        </div>

                        <div class="qr-group" id="used_annual_hours_group">
                            <label for="used_annual_hours">Annual Hours</label>
                            <div class="qr-hint">Required unless Cash</div>
                            <input type="number" id="used_annual_hours" name="annual_hours" class="qr-input" required />
                        </div>

                        <div class="qr-group" id="used_lease_term_group">
                            <label for="used_lease_term">Lease Term (Months)</label>
                            <div class="qr-hint">Required unless Cash</div>
                            <input type="number" id="used_lease_term" name="lease_term" class="qr-input" required />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="used_options_need">Options Need</label>
                            <input type="text" id="used_options_need" name="options_need" class="qr-input" />
                        </div>

                        <div class="qr-group qr-group-full">
                            <label for="used_additional_notes">Additional Notes</label>
                            <textarea id="used_additional_notes" name="additional_notes" class="qr-textarea"></textarea>
                        </div>

                    </div>

                    <div class="qr-actions">
                        <button type="submit" class="primary-button">
                            Generate Used Equipment Request PDF
                        </button>
                    </div>
                </form>
            </div>

<script>
    // ==========================================================
    // A) Field highlighting + "don't wipe" behavior
    //    - Client-side validation (highlights missed fields)
    //    - Session autosave (keeps data even if page refreshes)
    // ==========================================================

    function isVisible(el) {
        if (!el) return false;
        // Hidden by display:none anywhere up the tree
        if (el.offsetParent === null) return false;
        // Hidden by type=hidden or disabled
        if (el.type === "hidden" || el.disabled) return false;
        return true;
    }

    function groupFor(el) {
        if (!el) return null;
        return el.closest(".qr-group") || null;
    }

    function clearFieldError(el) {
        if (!el) return;
        el.classList.remove("qr-invalid");
        el.removeAttribute("aria-invalid");
        const g = groupFor(el);
        if (!g) return;
        g.classList.remove("qr-group-invalid");
        const msg = g.querySelector(".qr-error-msg");
        if (msg) msg.remove();
    }

    function setFieldError(el, message) {
        if (!el) return;
        el.classList.add("qr-invalid");
        el.setAttribute("aria-invalid", "true");
        const g = groupFor(el);
        if (g) {
            g.classList.add("qr-group-invalid");
            // Add message only once
            if (!g.querySelector(".qr-error-msg")) {
                const div = document.createElement("div");
                div.className = "qr-error-msg";
                div.textContent = message || "This field is required.";
                g.appendChild(div);
            }
        }
    }

    function clearFormErrors(form) {
        if (!form) return;
        const fields = form.querySelectorAll("input, select, textarea");
        fields.forEach(clearFieldError);
    }

    function isEmptyValue(el) {
        if (!el) return true;
        if (el.tagName === "SELECT") {
            const v = (el.value || "").trim();
            return v === "";
        }
        return ((el.value || "").trim() === "");
    }

    function validateForm(form) {
        if (!form) return true;

        clearFormErrors(form);

        const requiredFields = Array.from(form.querySelectorAll("input[required], select[required], textarea[required]"))
            .filter(isVisible);

        const invalid = [];

        requiredFields.forEach(el => {
            // ignore hidden electric blocks etc (handled by isVisible + required toggles you already do)
            if (isEmptyValue(el)) {
                invalid.push(el);
                setFieldError(el, "Required");
            }
        });

        if (invalid.length) {
            const first = invalid[0];
            // Scroll into view and focus
            try {
                first.scrollIntoView({ behavior: "smooth", block: "center" });
            } catch (e) {}
            setTimeout(() => {
                try { first.focus({ preventScroll: true }); } catch (e) {}
            }, 250);
            return false;
        }

        return true;
    }

    function storageKeyForForm(form) {
        const t = (form?.dataset?.requestType || "").trim() || "unknown";
        return `qr_draft_${t}`;
    }

    function saveDraft(form) {
        try {
            const key = storageKeyForForm(form);
            const data = {};
            const els = form.querySelectorAll("input, select, textarea");
            els.forEach(el => {
                if (!el.name) return;
                if (el.type === "password" || el.type === "file") return;
                if (el.type === "checkbox") data[el.name] = !!el.checked;
                else if (el.type === "radio") {
                    if (el.checked) data[el.name] = el.value;
                } else {
                    data[el.name] = el.value;
                }
            });
            sessionStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            // ignore storage errors
        }
    }

    function restoreDraft(form) {
        try {
            const key = storageKeyForForm(form);
            const raw = sessionStorage.getItem(key);
            if (!raw) return;
            const data = JSON.parse(raw);
            const els = form.querySelectorAll("input, select, textarea");
            els.forEach(el => {
                if (!el.name) return;
                if (!(el.name in data)) return;

                if (el.type === "checkbox") {
                    el.checked = !!data[el.name];
                } else if (el.type === "radio") {
                    el.checked = (data[el.name] === el.value);
                } else {
                    // only set if currently empty (prevents clobbering)
                    if ((el.value || "") === "") el.value = data[el.name];
                }
            });
        } catch (e) {
            // ignore
        }
    }

    function clearDraft(form) {
        try {
            sessionStorage.removeItem(storageKeyForForm(form));
        } catch (e) {}
    }

    function wireAutosave(form) {
        if (!form) return;

        // Restore on load
        restoreDraft(form);

        // Save on every change/input
        const handler = () => saveDraft(form);
        form.addEventListener("input", handler);
        form.addEventListener("change", handler);

        // As user fixes fields, remove red highlight immediately
        form.addEventListener("input", (e) => {
            if (!e.target) return;
            clearFieldError(e.target);
        });
        form.addEventListener("change", (e) => {
            if (!e.target) return;
            clearFieldError(e.target);
        });
    }

    // Wire autosave for all forms
    const allForms = document.querySelectorAll("form.quote-request-form");
    allForms.forEach(wireAutosave);

    // Desktop behavior: prevent submit if missing required
    // (keeps user on page with highlights, no wipe)
    allForms.forEach((form) => {
        form.addEventListener("submit", (e) => {
            // If mobile fetch handler is active, it will also run; validation should block both
            if (!validateForm(form)) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);
    });

    // -----------------------------
    // 1) Switch between forms
    // -----------------------------
    const requestTypeSelect = document.getElementById("request_type_select");
    const wrapQuote  = document.getElementById("form_wrap_quote");
    const wrapDemo   = document.getElementById("form_wrap_demo");
    const wrapRental = document.getElementById("form_wrap_rental");
    const wrapUsed   = document.getElementById("form_wrap_used");

    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");

    function setActiveForm(type) {
        wrapQuote.style.display  = "none";
        wrapDemo.style.display   = "none";
        wrapRental.style.display = "none";
        wrapUsed.style.display   = "none";

        if (type === "demo") {
            wrapDemo.style.display = "block";
            pageTitle.textContent = "HELI Demo Request";
            pageSubtitle.textContent = "Fill out every field below to generate a clean PDF for Lisa.";
            restoreDraft(document.getElementById("demoRequestForm"));
        } else if (type === "rental") {
            wrapRental.style.display = "block";
            pageTitle.textContent = "HELI Rental Request";
            pageSubtitle.textContent = "Fill out every field below to generate a clean PDF for Lisa.";
            restoreDraft(document.getElementById("rentalRequestForm"));
        } else if (type === "used") {
            wrapUsed.style.display = "block";
            pageTitle.textContent = "Used Equipment Request";
            pageSubtitle.textContent = "Fill out every field below to generate a clean PDF for Lisa.";
            restoreDraft(document.getElementById("usedRequestForm"));
        } else {
            wrapQuote.style.display = "block";
            pageTitle.textContent = "HELI Quote Request";
            pageSubtitle.textContent = "Fill out every field below to generate a clean PDF for Lisa.";
            restoreDraft(document.getElementById("quoteRequestForm"));
        }
    }

    if (requestTypeSelect) {
        requestTypeSelect.addEventListener("change", () => setActiveForm(requestTypeSelect.value));
        setActiveForm(requestTypeSelect.value);
    }



    // -----------------------------
    // 2) Quote Fuel -> Battery Voltage requirement
    // -----------------------------
    const fuelSelect = document.getElementById('fuel_type');
    const voltageGroup = document.getElementById('battery_voltage_group');
    const voltageInput = document.getElementById('battery_voltage');

    function updateVoltageVisibility() {
        if (!fuelSelect || !voltageGroup || !voltageInput) return;
        const isElectric = fuelSelect.value === 'Electric';
        if (isElectric) {
            voltageGroup.style.display = 'block';
            voltageInput.setAttribute('required', 'required');
        } else {
            voltageGroup.style.display = 'none';
            voltageInput.removeAttribute('required');
            voltageInput.value = '';
            clearFieldError(voltageInput);
        }
    }

    if (fuelSelect) {
        updateVoltageVisibility();
        fuelSelect.addEventListener('change', updateVoltageVisibility);
    }

    // -----------------------------
    // 3) Demo/Rental power type behavior
    // -----------------------------
    function wirePowerTypeBehavior(selectId, electricBlockId, lpGroupId) {
        const sel = document.getElementById(selectId);
        const electricBlock = document.getElementById(electricBlockId);
        const lpGroup = document.getElementById(lpGroupId);

        if (!sel) return;

        function clearInputs(container) {
            if (!container) return;
            const inputs = container.querySelectorAll("input, select, textarea");
            inputs.forEach(el => {
                if (el.tagName === "SELECT") el.selectedIndex = 0;
                else el.value = "";
                clearFieldError(el);
            });
        }

        function update() {
            const isElectric = (sel.value || "").toLowerCase() === "electric";

            if (electricBlock) {
                electricBlock.style.display = isElectric ? "block" : "none";
                if (!isElectric) clearInputs(electricBlock);
            }

            if (lpGroup) {
                lpGroup.style.display = isElectric ? "none" : "block";
                if (isElectric) clearInputs(lpGroup);
            }
        }

        update();
        sel.addEventListener("change", update);
    }

    wirePowerTypeBehavior("demo_power_type", "demo_electric_block", "demo_need_lp_tank_group");
    wirePowerTypeBehavior("rental_power_type", "rental_electric_block", "rental_need_lp_tank_group");

    // -----------------------------
    // 4) Used Equipment fuel behavior
    // -----------------------------
    (function wireUsedElectric() {
        const sel = document.getElementById("used_fuel_type");
        const gVolt = document.getElementById("used_voltage_group");
        const gLine = document.getElementById("used_line_voltage_group");
        const iVolt = document.getElementById("used_voltage");
        const iLine = document.getElementById("used_line_voltage");

        if (!sel) return;

        function update() {
            const isElectric = (sel.value || "").trim().toLowerCase() === "electric";
            if (gVolt) gVolt.style.display = isElectric ? "block" : "none";
            if (gLine) gLine.style.display = isElectric ? "block" : "none";

            if (iVolt) {
                if (isElectric) iVolt.setAttribute("required", "required");
                else {
                    iVolt.removeAttribute("required");
                    iVolt.selectedIndex = 0;
                    clearFieldError(iVolt);
                }
            }
            if (iLine) {
                if (isElectric) iLine.setAttribute("required", "required");
                else {
                    iLine.removeAttribute("required");
                    iLine.value = "";
                    clearFieldError(iLine);
                }
            }
        }

        update();
        sel.addEventListener("change", update);
    })();

    // -----------------------------
    // 4.5) Cash behavior (Quote form)
    // -----------------------------
    (function wireCash() {
        const leaseType = document.getElementById("lease_type");
        const leaseTerm = document.getElementById("lease_term");
        const annualHours = document.getElementById("annual_hours");

        if (!leaseType || !leaseTerm || !annualHours) return;

        const leaseTermGroup = leaseTerm.closest(".qr-group");
        const annualHoursGroup = annualHours.closest(".qr-group");

        function update() {
            const isCash = (leaseType.value || "").toLowerCase() === "cash";

            if (leaseTermGroup) leaseTermGroup.style.display = isCash ? "none" : "";
            if (annualHoursGroup) annualHoursGroup.style.display = isCash ? "none" : "";

            if (isCash) {
                leaseTerm.removeAttribute("required");
                annualHours.removeAttribute("required");
                leaseTerm.value = "";
                annualHours.value = "";
                clearFieldError(leaseTerm);
                clearFieldError(annualHours);
            } else {
                leaseTerm.setAttribute("required", "required");
                annualHours.setAttribute("required", "required");
            }
        }

        update();
        leaseType.addEventListener("change", update);
    })();

    // -----------------------------
    // 4B) Used Equipment Cash behavior
    // -----------------------------
    (function wireUsedLeaseCash() {
        const leaseType = document.getElementById("used_lease_type");
        const leaseTerm = document.getElementById("used_lease_term");
        const annualHours = document.getElementById("used_annual_hours");

        if (!leaseType || !leaseTerm || !annualHours) return;

        const leaseTermGroup = document.getElementById("used_lease_term_group") || leaseTerm.closest(".qr-group");
        const annualHoursGroup = document.getElementById("used_annual_hours_group") || annualHours.closest(".qr-group");

        function update() {
            const isCash = (leaseType.value || "").trim().toLowerCase() === "cash";

            if (leaseTermGroup) leaseTermGroup.style.display = isCash ? "none" : "";
            if (annualHoursGroup) annualHoursGroup.style.display = isCash ? "none" : "";

            if (isCash) {
                leaseTerm.removeAttribute("required");
                annualHours.removeAttribute("required");
                leaseTerm.value = "";
                annualHours.value = "";
                clearFieldError(leaseTerm);
                clearFieldError(annualHours);
            } else {
                leaseTerm.setAttribute("required", "required");
                annualHours.setAttribute("required", "required");
            }
        }

        update();
        leaseType.addEventListener("change", update);
    })();

    // -----------------------------
    // 5) Mobile Share/Save behavior (UPDATED)
    //    - Validates first
    //    - If server returns HTML, show a friendly message and render it
    // -----------------------------
    (function () {
        const hint = document.getElementById("mobileSaveHint");
        const ua = navigator.userAgent || "";
        const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);

        if (!isMobile) {
            if (hint) hint.style.display = "none";
            return;
        }
        if (hint) hint.style.display = "block";

        const forms = document.querySelectorAll("form.quote-request-form");
        forms.forEach((form) => {
            form.addEventListener("submit", async (e) => {
                // If invalid, block submit and keep data (no wipe)
                if (!validateForm(form)) {
                    e.preventDefault();
                    return;
                }

                e.preventDefault();

                const btn = form.querySelector("button[type='submit']");
                const originalText = btn ? btn.textContent : "Generating PDF...";
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = "Generating PDF...";
                }

                try {
                    const formData = new FormData(form);

                    const res = await fetch(form.action, {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-Requested-With": "fetch",
                            "Accept": "application/pdf"
                        }
                    });

                    const contentType = (res.headers.get("content-type") || "").toLowerCase();

                    // If not PDF, it usually means validation error or redirect -> HTML
                    if (!res.ok || !contentType.includes("application/pdf")) {
                        const html = await res.text().catch(() => "");
                        // Render returned HTML so user sees server-side errors (instead of raw HTML alert)
                        document.open();
                        document.write(html);
                        document.close();
                        return;
                    }

                    const blob = await res.blob();

                    const dispo = res.headers.get("content-disposition") || "";
                    const match = dispo.match(/filename="(.+?)"/);
                    const defaultName = (form.dataset.requestType || "request") + "_request.pdf";
                    const filename = match ? match[1] : defaultName;

                    const file = new File([blob], filename, { type: "application/pdf" });

                    // Success: clear draft + reset form (optional)
                    clearDraft(form);

                    if (navigator.canShare && navigator.share && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: form.dataset.pdfTitle || "HELI Request",
                            text: "Request PDF",
                            files: [file],
                        });
                        return;
                    }

                    const url = URL.createObjectURL(blob);
                    window.open(url, "_blank");
                    setTimeout(() => URL.revokeObjectURL(url), 30000);

                } catch (err) {
                    alert("Failed to generate/share the PDF. Please check required fields or try again.");
                } finally {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                }
            }, true);
        });
    })();
</script>

</body>
</html>
