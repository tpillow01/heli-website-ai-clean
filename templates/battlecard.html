<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Battle Card – {{ model.model }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=51) }}">

  <style>
    :root{
      /* spacing */
      --edge: 28px;          /* safe padding inside cards */
      --gap:  22px;          /* gaps between blocks */
      --gap-sm: 14px;

      /* palette */
      --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6;
      --ink:#3b2a23; --muted:#746055; --brand:#a9342a; --brand-2:#c64a3f;
    }

    body{color:var(--ink)}

    /* ===== Top header (site) ===== */
    .bc-top{
      position:sticky; top:0; z-index:50;
      background:rgba(246,239,227,.92);
      backdrop-filter:saturate(1.05) blur(6px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1180px;margin:0 auto;padding:14px 18px}
    .brand-line{display:flex;align-items:center;justify-content:space-between}
    .brand-left{font-weight:900;color:#6e4d3e}
    .brand-right{font-weight:900;color:#a9342a;letter-spacing:.08em}
    .tabs{display:flex;gap:18px;margin-top:6px}
    .nav-link{font-weight:800;text-decoration:none;color:var(--ink);position:relative;padding:8px 0}
    .nav-link.active{color:#1f1713}
    .nav-link.active::after{content:"";position:absolute;left:0;bottom:-6px;width:30px;height:3px;border-radius:2px;background:var(--brand)}

    /* ===== Page layout ===== */
    .page{max-width:1180px;margin:0 auto;padding: 20px 18px 36px}
    .grid{display:grid;grid-template-columns:3fr 1.35fr;gap:var(--gap)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* ===== Card base ===== */
    .card{
      background:var(--cream);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0;
      padding: var(--edge);
    }
    .card > * + *{margin-top: var(--gap-sm)}
    .card p, .card li{line-height:1.55}

    /* ===== Hero ===== */
    .hero{
      display:grid;
      grid-template-columns: 1fr auto;   /* title | button */
      align-items:center;
      gap: var(--gap-sm);
    }
    .title{
      margin:0; font-weight:900; line-height:1.15;
      font-size: clamp(22px, 2.2vw, 32px);
      position:relative; padding-bottom:4px;
    }
    .title::after{
      content:""; position:absolute; left:0; bottom:-2px; height:4px; width:72px; border-radius:3px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2));
    }

    .btn{
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
      padding:11px 14px; border-radius:12px; cursor:pointer; font-weight:800; color:#5e4b3f;
      border:2px solid transparent;
      background:linear-gradient(#fff,#fff) padding-box, linear-gradient(135deg,var(--brand),var(--brand-2)) border-box;
      box-shadow:0 6px 16px rgba(50,40,30,.10);
    }
    .btn:hover{box-shadow:0 10px 26px rgba(50,40,30,.16), 0 0 0 4px rgba(201,68,58,.08)}
    .btn svg{display:block}

    /* Pills & metrics have generous interior padding so text never touches edges */
    .pills{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .pill{
      background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px;
      font-weight:800; color:#63463a; box-shadow: inset 0 1px 0 #fff, 0 6px 12px rgba(50,40,30,.05);
    }

    .metrics{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap: 14px; margin-top:12px}
    @media (max-width:560px){.metrics{grid-template-columns:1fr}}
    .metric{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding: 14px 16px;
    }
    .metric .k{font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:#866f62; font-weight:900; margin-bottom:4px}
    .metric .v{font-weight:900; color:var(--ink); font-size:18px}

    /* Sections */
    .block h2{margin:0 0 8px 0; font-size:20px; font-weight:900}
    .kv{display:flex; gap:8px; margin:6px 0}
    .kv .k{font-weight:900}
    .kv .v{color:var(--muted)}
    .why ul{margin:4px 0 0 0; padding-left:1.15em}
    .why li{margin:7px 0}

    /* Specs side card */
    .specs h3{margin:0 0 10px 2px; font-size:18px; font-weight:900}
    .spec{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:1px solid var(--line); border-radius:12px; padding: 12px 14px; margin:10px 0;
    }
    .spec .k{color:#7a5f53; font-weight:900}
    .spec .v{color:#2f241f; font-weight:900}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:60; padding:28px}
    .modal.show{display:grid}
    .modal-card{
      width:min(920px,96vw); max-height:85vh; overflow:auto;
      background:var(--cream); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25)
    }
    .modal-head{
      position:sticky; top:0; z-index:1; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border-bottom:1px solid var(--line); background:#fff
    }
    .segmented{display:inline-flex; gap:4px; background:#f7efe2; border:1px solid var(--line); border-radius:12px; padding:4px}
    .tab{appearance:none; border:0; background:transparent; color:#604c41; font-weight:900; padding:8px 12px; border-radius:10px; cursor:pointer; min-width:140px}
    .tab.active{background:#fff; border:1px solid var(--line); box-shadow:0 4px 12px rgba(50,40,30,.10)}
    .close-x{border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900}
    .modal-body{padding: 18px 20px}
    .modal-body .briefing-content h2{margin: 8px 0 6px; font-size:22px; font-weight:900; border-bottom:2px solid #ead9c6; padding-bottom:6px}
    .modal-body .briefing-content ul{margin:8px 0 12px; padding-left:1.15em}
    .modal-body .briefing-content li{margin: 6px 0; line-height:1.55}

    /* Responsive: if the hero gets tight, drop the button below title neatly */
    @media (max-width:640px){
      .hero{grid-template-columns:1fr}
      .hero .btn{justify-self:start}
    }
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header class="bc-top">
    <div class="container">
      <div class="brand-line">
        <div class="brand-left">Tynan Equipment AI</div>
        <div class="brand-right">HELI</div>
      </div>
      <nav class="tabs">
        <a href="/" class="nav-link">Chat</a>
        <a href="/map" class="nav-link">Map</a>
        <a href="/battlecards" class="nav-link active">Battle Cards</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <div class="grid">
      <!-- LEFT COLUMN -->
      <section class="card">
        <div class="hero">
          <h1 class="title">{{ model.series }} – {{ model.model }}</h1>

          <!-- Open Briefing button: top-right of hero -->
          <button id="open-briefing-trigger" class="btn" type="button" data-slug="{{ model._slug }}">
            <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Open Briefing
          </button>
        </div>

        <div class="pills">
          {% if model.power %}<span class="pill">{{ model.power }}</span>{% endif %}
          {% if model.capacity %}<span class="pill">Capacity: {{ model.capacity }}</span>{% endif %}
          {% if model.drive_type and model.drive_type != '—' %}<span class="pill">{{ model.drive_type }}</span>{% endif %}
        </div>

        <div class="metrics">
          <div class="metric"><div class="k">Width</div><div class="v">{{ model.overall_width }}</div></div>
          <div class="metric"><div class="k">Turning</div><div class="v">{{ model.turning_radius }}</div></div>
          <div class="metric"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        </div>
      </section>

      <!-- RIGHT COLUMN: Specs -->
      <aside class="card specs">
        <h3>Key Specs</h3>
        <div class="spec"><div class="k">Power</div><div class="v">{{ model.power }}</div></div>
        <div class="spec"><div class="k">Drive Type</div><div class="v">{{ model.drive_type }}</div></div>
        <div class="spec"><div class="k">Controller</div><div class="v">{{ model.controller }}</div></div>
        <div class="spec"><div class="k">Capacity</div><div class="v">{{ model.capacity }}</div></div>
        <div class="spec"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        <div class="spec"><div class="k">Turning Radius</div><div class="v">{{ model.turning_radius }}</div></div>
        <div class="spec"><div class="k">Overall Width</div><div class="v">{{ model.overall_width }}</div></div>
        <div class="spec"><div class="k">Overall Length</div><div class="v">{{ model.overall_length }}</div></div>
        <div class="spec"><div class="k">Overall Height</div><div class="v">{{ model.overall_height }}</div></div>
        <div class="spec"><div class="k">Wheel Base</div><div class="v">{{ model.wheel_base }}</div></div>
        <div class="spec"><div class="k">Max Lift Height</div><div class="v">{{ model.max_lift_height }}</div></div>
        <div class="spec"><div class="k">Battery Voltage</div><div class="v">{{ model.battery_voltage }}</div></div>
      </aside>

      <!-- Best Environments -->
      <section class="card">
        <h2>Best Environments</h2>
        <p class="kv"><span class="k">Indoors:</span><span class="v">{{ model.indoors }}</span></p>
        <p class="kv"><span class="k">Outdoors:</span><span class="v">{{ model.outdoors }}</span></p>
        <p class="kv"><span class="k">Special:</span><span class="v">{{ model.special_env }}</span></p>
      </section>

      <!-- Why it wins -->
      <section class="card why" style="grid-column:1 / -1">
        <h2>Why It Wins</h2>
        <ul>
          {% for w in model.why_wins %}<li>{{ w }}</li>{% endfor %}
        </ul>
      </section>
    </div>
  </main>

  <!-- Briefing Modal -->
  <div id="briefing-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="modal-card">
      <div class="modal-head">
        <div class="segmented" role="tablist" aria-label="Briefing tabs">
          <button class="tab active" role="tab" aria-selected="true"  aria-controls="tab-fit"  id="tabbtn-fit"  data-tab="fit">Fit Briefing</button>
        </div>
        <button class="close-x" aria-label="Close briefing">Close</button>
      </div>
      <div class="modal-body" id="tab-panel">
        <p class="loading">Loading briefing…</p>
      </div>
    </div>
  </div>

  <!-- Briefing JS -->
  <script>
  (function () {
    var openBtn = document.getElementById('open-briefing-trigger');
    var modal   = document.getElementById('briefing-modal');
    var body    = modal.querySelector('.modal-body');
    var closeX  = modal.querySelector('.close-x');
    var slug    = openBtn.getAttribute('data-slug');

    function openModal() {
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function fetchBriefing() {
      body.innerHTML = '<p class="loading">Loading briefing…</p>';
      fetch('/api/ai_fit?model=' + encodeURIComponent(slug))
        .then(function(r){ return r.json(); })
        .then(function(j){
          if (j && j.html) {
            body.innerHTML = '<div class="briefing-content">'+ j.html +'</div>';
          } else {
            body.innerHTML = '<p>Error: ' + (j && j.error ? j.error : 'No content returned') + '</p>';
          }
        })
        .catch(function(err){
          body.innerHTML = '<p>Error loading briefing: ' + String(err) + '</p>';
        });
    }

    openBtn.addEventListener('click', function(){ openModal(); fetchBriefing(); });
    closeX.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeModal(); });
  })();
  </script>
</body>
</html>
