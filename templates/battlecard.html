{% set title = (model.model or model._display) %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ title }} – Battle Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=20) }}">
  <style>
    :root{ --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6; --ink:#5e4b3f; --muted:#8a796d; --brand:#cc0000; }
    body{margin:0;background:repeating-linear-gradient(0deg,#f3eadc 0 28px,#f1e6d6 28px 29px);color:var(--ink)}
    .top{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.6);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .brand{display:flex;justify-content:space-between;align-items:center}
    .brand .left{font-weight:900;color:#7e5140}
    .brand .right{font-weight:900;color:#a9342a;letter-spacing:.08em}
    .tabs{display:flex;gap:16px;align-items:center;margin:10px 0 8px}
    .nav-link{background:transparent;border:none;padding:8px 0;color:var(--ink);font-weight:800;text-decoration:none;border-radius:6px;position:relative}
    .nav-link:hover{color:#3c2f28}
    .nav-link.active{color:#1f1713}
    .nav-link.active::after{content:"";position:absolute;left:0;bottom:-6px;width:24px;height:3px;border-radius:2px;background:var(--brand)}

    .crumbs{margin:8px 0 2px}
    .crumbs a{color:#7b6559;text-decoration:none}
    .crumbs a:hover{text-decoration:underline}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;align-items:center;margin:10px 0}
    .title{margin:0 0 2px 0;color:#613f34}
    .tag{color:#a9342a;font-weight:800;letter-spacing:.06em}
    .sil{height:180px;border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,#f8f2e9,#f4eadf);box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
    .panel{background:var(--cream);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0}
    .panel h2{margin:0 0 8px 0;color:#6b4c3e}
    .specs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .specs div{display:flex;justify-content:space-between;gap:10px;background:var(--cream-2);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .specs span{color:var(--muted)}
    .bullets{margin:0;padding-left:18px}
    .cta{display:flex;justify-content:center;margin:18px 0 4px}
    .btn-ask{background:linear-gradient(#d8493f,#c61c10);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:900;letter-spacing:.03em;box-shadow:0 6px 18px rgba(204,0,0,.25);cursor:pointer}
    .btn-ask:hover{filter:brightness(1.02)}
    dialog.ai{border:none;border-radius:18px;padding:0;background:transparent}
    dialog.ai::backdrop{background:rgba(0,0,0,.35)}
    .modal{background:var(--cream);border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0;width:min(760px,92vw)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .modal-body{padding:16px;min-height:140px;color:#493a31}
    .btn-close{background:#fff;border:1px solid var(--line);border-radius:10px;padding:7px 10px;font-weight:700;color:#63463a}
    .spinner{width:34px;height:34px;border-radius:50%;border:4px solid #e0d4c4;border-top-color:#cc0000;margin:24px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:900px){ .hero{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="brand">
        <div class="left">Tynan Equipment AI</div>
        <div class="right">HELI</div>
      </div>
      <nav class="tabs">
        <a href="/"            class="nav-link {{ 'active' if request.path == '/' else '' }}">Chat</a>
        <a href="/map"         class="nav-link {{ 'active' if request.path.startswith('/map') else '' }}">Map</a>
        <a href="/battlecards" class="nav-link {{ 'active' if request.path.startswith('/battlecards') else '' }}">Battle Cards</a>
      </nav>
    </div>
  </div>

  <main class="wrap">
    <div class="crumbs"><a href="/battlecards">← Back to Battle Cards</a></div>

    <section class="hero">
      <div>
        <h1 class="title">{{ (model.series or "Series") | upper }} – {{ title }}</h1>
        <div class="tag">Fast • Tough • Efficient</div>
      </div>
      <div class="sil" aria-hidden="true"></div>
    </section>

    <section class="grid">
      <article class="panel">
        <h2>Best Environments</h2>
        <ul class="bullets">
          <li>Indoors: {{ model.indoors }}</li>
          <li>Outdoors: {{ model.outdoors }}</li>
          <li>Special: {{ model.special_env }}</li>
        </ul>
      </article>

      <article class="panel">
        <h2>Key Specs</h2>
        <div class="specs">
          <div><span>Power</span><b>{{ model.power }}</b></div>
          <div><span>Drive Type</span><b>{{ model.drive_type }}</b></div>
          <div><span>Controller</span><b>{{ model.controller }}</b></div>
          <div><span>Capacity</span><b>{{ model.capacity }}</b></div>
          <div><span>Load Center</span><b>{{ model.load_center }}</b></div>
          <div><span>Turning Radius</span><b>{{ model.turning_radius }}</b></div>
          <div><span>Overall Width</span><b>{{ model.overall_width }}</b></div>
          <div><span>Overall Length</span><b>{{ model.overall_length }}</b></div>
          <div><span>Overall Height</span><b>{{ model.overall_height }}</b></div>
          <div><span>Wheel Base</span><b>{{ model.wheel_base }}</b></div>
          <div><span>Max Lift Height</span><b>{{ model.max_lift_height }}</b></div>
          <div><span>Battery Voltage</span><b>{{ model.battery_voltage }}</b></div>
        </div>
      </article>

      <article class="panel" style="grid-column:1/-1">
        <h2>Why It Wins</h2>
        <ul class="bullets">
          {% for p in model.why_wins %}<li>{{ p }}</li>{% endfor %}
        </ul>
      </article>
    </section>

    <div class="cta">
      <button id="askAiBtn" class="btn-ask">ASK AI FOR FIT</button>
    </div>

    <dialog id="aiFitDialog" class="ai">
      <div class="modal">
        <div class="modal-head">
          <h3>AI Fit – {{ title }}</h3>
          <button id="closeAi" class="btn-close">Close</button>
        </div>
        <div id="aiOutput" class="modal-body"><div class="spinner"></div></div>
      </div>
    </dialog>
  </main>

  <script>
    const slug = "{{ model._slug }}";
    const btn = document.getElementById('askAiBtn');
    const dlg = document.getElementById('aiFitDialog');
    const out = document.getElementById('aiOutput');
    const closeBtn = document.getElementById('closeAi');

    btn.addEventListener('click', async () => {
      out.innerHTML = '<div class="spinner"></div>';
      if (typeof dlg.showModal === 'function') dlg.showModal();
      try {
        const r = await fetch(`/api/ai_fit?model=${encodeURIComponent(slug)}`);
        const j = await r.json();
        out.innerHTML = j.html ? j.html : `<pre>${(j.error||'Unknown error')}</pre>`;
      } catch (e) {
        out.innerHTML = `<pre>${e}</pre>`;
      }
    });
    closeBtn.addEventListener('click', () => dlg.close());
  </script>
</body>
</html>
