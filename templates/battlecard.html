<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Battle Card – {{ model.model }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css', v=47) }}">

  <style>
    :root{
      --cream:#f6efe3; --cream-2:#fbf6ee; --line:#e7dac6;
      --ink:#3b2a23; --sub:#866f62; --muted:#7b6559; --brand:#a9342a;
      --card-pad: 24px;
      --block-pad: 24px;
      --modal-pad: 24px;
    }

    /* Mobile-safe scrolling */
    html, body{
      height:auto;
      min-height:100%;
      overflow-y:auto !important;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      background-attachment: scroll !important;
    }
    body{ color:var(--ink); }

    /* wrapper */
    .bc-page{ max-width:1180px; margin:0 auto; padding:18px; scroll-margin-top:12px; }
    @media (max-width:720px){ .bc-page{ padding:14px; } }

    .back-link{ display:inline-block; margin:6px 0 14px 2px; color:#7a4d3a; font-weight:700; text-decoration:none; }
    .back-link:hover{ text-decoration:underline; }

    /* grid */
    .bc-grid{ display:grid; grid-template-columns: 3fr 1.4fr; gap:18px; align-items:start; }
    @media (max-width: 980px){ .bc-grid{ grid-template-columns: 1fr; } }

    /* card look */
    .card{
      background:var(--cream);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 26px rgba(93,69,49,.08), inset 0 1px 0 #fff8f0;
    }

    /* HERO */
    .bc-hero{ padding:var(--card-pad); }
    .bc-hero-bar{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .bc-title{ margin:0; font-weight:900; color:var(--ink); line-height:1.15; font-size:clamp(22px,2.2vw,32px); }
    .btn-briefing{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--line);
      background:#fff; color:#5e4b3f; font-weight:800; cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.06); transition:transform .06s ease, box-shadow .06s ease;
      white-space:nowrap;
    }
    .btn-briefing:hover{ box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .btn-briefing:active{ transform:translateY(1px); }
    .btn-briefing svg{ display:block; }

    .bc-hero-pills{ display:flex; flex-wrap:wrap; gap:10px; margin:12px 0; }
    .pill{
      background:#fff; border:1px solid var(--line);
      border-radius:999px; padding:8px 12px; font-weight:800; color:#63463a; white-space:nowrap;
    }

    .bc-hero-metrics{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width: 540px){ .bc-hero-metrics{ grid-template-columns: 1fr; } }
    .metric{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px 16px; }
    .metric .k{ font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:var(--sub); margin-bottom:6px; font-weight:800; }
    .metric .v{ font-size:18px; color:var(--ink); font-weight:900; }

    /* content blocks */
    .block{ padding:var(--block-pad); }
    .block h2{ margin:0 0 14px 0; font-size:20px; font-weight:900; }
    .kv{ display:flex; gap:10px; margin:8px 0; }
    .kv .k{ color:var(--ink); font-weight:800; }
    .kv .v{ color:var(--muted); }
    .block ul{ margin:10px 0 0 0; padding-left:28px; }
    .block li{ margin:7px 0; }

    /* specs panel */
    .specs{ padding:18px; }
    .specs h3{ margin:6px 10px 14px 10px; font-weight:900; font-size:18px; }
    .spec-row{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:1px solid var(--line); border-radius:10px;
      padding:13px 16px; margin:12px 0;
    }
    .spec-row .k{ color:#7a5f53; font-weight:900; }
    .spec-row .v{ color:#2f241f; font-weight:900; text-align:right; }

    /* modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45);
      z-index:999; padding:24px;
      -webkit-overflow-scrolling: touch;
    }
    .modal.show{ display:grid; }
    .modal-card{
      width:min(900px, 96vw); max-height:85vh; overflow:auto;
      background:var(--cream); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25);
      -webkit-overflow-scrolling: touch;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:12px 16px; border-bottom:1px solid var(--line); background:#fff;
      position:sticky; top:0;
    }
    .modal-title{ font-weight:900; }
    .close-x{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:900; }

    /* Center the briefing content */
    .modal-body{
      padding:var(--modal-pad);
      line-height:1.65;
      display:flex;                 /* center container */
      justify-content:center;
    }
    .briefing-inner{
      width:100%;
      max-width:720px;              /* nice readable line length */
      margin:0 auto;
      text-align:left;
    }
    .modal-body p{ margin:.65em 0; }
    .modal-body ul{ padding-left:24px; }
    .loading{ font-style:italic; color:#6b5a50; }

    /* lock body scroll when modal open */
    .modal-open{ overflow:hidden !important; height:100% !important; }

    @media (max-width:680px){
      .bc-hero-bar{ flex-direction:column; align-items:flex-start; gap:10px; }
      .btn-briefing{ width:100%; justify-content:center; }
      :root{ --card-pad:20px; --block-pad:20px; --modal-pad:22px; }
      .briefing-inner{ max-width:600px; }   /* slightly narrower on small devices */
    }
  </style>
</head>
<body>
  <div id="card-top" class="bc-page">
    <a class="back-link" href="{{ url_for('battlecards_index') }}">← Back to Battle Cards</a>

    <div class="bc-grid">
      <!-- LEFT COLUMN -->
      <div class="left-col">
        <!-- HERO -->
        <section class="card bc-hero">
          <div class="bc-hero-bar">
            <h1 class="bc-title">{{ model.series }} – {{ model.model }}</h1>

            <button id="open-briefing-trigger" class="btn-briefing" type="button" aria-haspopup="dialog">
              <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
              Open Briefing
            </button>
          </div>

          <div class="bc-hero-pills">
            {% if model.power %}<span class="pill">{{ model.power }}</span>{% endif %}
            {% if model.capacity %}<span class="pill">Capacity: {{ model.capacity }}</span>{% endif %}
            {% if model.drive_type and model.drive_type != '—' %}<span class="pill">{{ model.drive_type }}</span>{% endif %}
          </div>

          <div class="bc-hero-metrics">
            <div class="metric"><div class="k">Width</div><div class="v">{{ model.overall_width }}</div></div>
            <div class="metric"><div class="k">Turning</div><div class="v">{{ model.turning_radius }}</div></div>
            <div class="metric"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
          </div>
        </section>

        <!-- Best Environments -->
        <section class="card block">
          <h2>Best Environments</h2>
          <p class="kv"><span class="k">Indoors:</span><span class="v">{{ model.indoors }}</span></p>
          <p class="kv"><span class="k">Outdoors:</span><span class="v">{{ model.outdoors }}</span></p>
          <p class="kv"><span class="k">Special:</span><span class="v">{{ model.special_env }}</span></p>
        </section>

        <!-- Why it wins -->
        <section class="card block">
          <h2>Why It Wins</h2>
          <ul>
            {% for w in model.why_wins %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        </section>
      </div>

      <!-- RIGHT COLUMN: Key Specs -->
      <aside class="card specs">
        <h3>Key Specs</h3>

        <div class="spec-row"><div class="k">Power</div><div class="v">{{ model.power }}</div></div>
        <div class="spec-row"><div class="k">Drive Type</div><div class="v">{{ model.drive_type }}</div></div>
        <div class="spec-row"><div class="k">Controller</div><div class="v">{{ model.controller }}</div></div>

        <div class="spec-row"><div class="k">Capacity</div><div class="v">{{ model.capacity }}</div></div>
        <div class="spec-row"><div class="k">Load Center</div><div class="v">{{ model.load_center }}</div></div>
        <div class="spec-row"><div class="k">Turning Radius</div><div class="v">{{ model.turning_radius }}</div></div>

        <div class="spec-row"><div class="k">Overall Width</div><div class="v">{{ model.overall_width }}</div></div>
        <div class="spec-row"><div class="k">Overall Length</div><div class="v">{{ model.overall_length }}</div></div>
        <div class="spec-row"><div class="k">Overall Height</div><div class="v">{{ model.overall_height }}</div></div>

        <div class="spec-row"><div class="k">Wheel Base</div><div class="v">{{ model.wheel_base }}</div></div>
        <div class="spec-row"><div class="k">Max Lift Height</div><div class="v">{{ model.max_lift_height }}</div></div>
        <div class="spec-row"><div class="k">Battery Voltage</div><div class="v">{{ model.battery_voltage }}</div></div>
      </aside>
    </div><!-- /bc-grid -->
  </div><!-- /bc-page -->

  <!-- Safely pass data to JS without raw Jinja in code -->
  <script id="page-data" type="application/json">
    {{ {"slug": model._slug}|tojson }}
  </script>

  <!-- Briefing Modal -->
  <div id="briefing-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="briefing-title">Briefing</div>
        <button class="close-x" aria-label="Close briefing">Close</button>
      </div>
      <div class="modal-body">
        <p class="loading">Loading briefing…</p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      /* Always start at top (new load + iOS bfcache restore) */
      if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; }
      function forceTop() {
        var topEl = document.getElementById('card-top');
        if (topEl && topEl.scrollIntoView) { topEl.scrollIntoView({block:'start', inline:'nearest'}); }
        else { window.scrollTo(0, 0); }
      }
      forceTop();
      document.addEventListener('DOMContentLoaded', forceTop, { once: true });
      requestAnimationFrame(forceTop);
      window.addEventListener('pageshow', function (e) { if (e.persisted) { forceTop(); } });

      // Read slug from the JSON script (no raw Jinja in JS)
      function getSlug(){
        try {
          var el = document.getElementById('page-data');
          var data = JSON.parse(el.textContent || '{}');
          return data.slug || '';
        } catch (e) {
          return '';
        }
      }

      // Modal controls
      var openBtn = document.getElementById('open-briefing-trigger');
      var modal   = document.getElementById('briefing-modal');
      var bodyBox = modal.querySelector('.modal-body');
      var closeX  = modal.querySelector('.close-x');

      function openModal() {
        modal.classList.add('show');
        document.body.classList.add('modal-open');  // lock page scroll while modal open
      }
      function closeModal() {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open'); // unlock page scroll
      }

      async function fetchBriefing() {
        bodyBox.innerHTML = '<p class="loading">Loading briefing…</p>';
        try {
          var slug = getSlug();
          var r = await fetch('/api/ai_fit?model=' + encodeURIComponent(slug), { cache: 'no-store' });
          var j = await r.json();
          if (j && j.html) {
            // Center the briefing by wrapping it in a max-width container
            bodyBox.innerHTML = '<div class="briefing-inner">' + j.html + '</div>';
          } else {
            bodyBox.innerHTML = '<div class="briefing-inner"><p>Error: No briefing returned.</p></div>';
          }
        } catch (err) {
          bodyBox.innerHTML = '<div class="briefing-inner"><p>Error loading briefing: ' + String(err) + '</p></div>';
        }
      }

      if (openBtn) {
        openBtn.addEventListener('click', function () {
          openModal();
          fetchBriefing();
        });
      }
      closeX.addEventListener('click', closeModal);
      modal.addEventListener('click', function (e) { if (e.target === modal) { closeModal(); } });
    })();
  </script>
</body>
</html>
